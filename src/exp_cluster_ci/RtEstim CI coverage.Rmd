---
title: "RtEstim CI coverage"
author: "Olivia"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    number_sections: true
bibliography: exp.bib
csl: biomed-central.csl
---

```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(utils)
library(forcats)
knitr::opts_chunk$set(echo = TRUE)
source(here::here("src/exp_cluster/load_functions.R"))
source(here::here("src/exp_cluster_ci/generate_data_ci.R"))
source(here::here("src/exp_cluster_ci/design_algos_ci.R"))
```

# Experimental design

We run experiments to compare the coverage of true Rt of 95% confidence intervals of all methods.

We consider epidemics of length 300 and 4 scenarios of Rt. We use two sets of gamma parameters (estimates of measles and SARS from previous literature) for serial interval distribution to generate the total infectiousness. 
We consider two distributional assumptions (Poisson and negative Binomial) of incidence.
We solve each scenario using EpiEstim (weekly and monthly sliding windows), EpiLPS, EpiFilter, and RtEstim with degrees k = 0,1,2,3. 

We output a vector of the CI coverage for each timepoint per experiment, the percentage of coverage of all timepoints, and the interval score $$score_{\alpha}(y,u,l) = (u-l) + \frac{2}{\alpha}(l-y)\boldsymbol{1}_{(y<l)} + \frac{2}{\alpha}(y-u)\boldsymbol{1}_{(y>u)}$$, where $\alpha=0.05$ is the significance level, $l,u$ are the lower and upper bounds, $y$ is the true Rt [@Bracher_2021].
For EpiEstim, whose Rt estimates and confidence bands miss the first few timepoints, we compute its percentage of CI coverage by averaging its vector of CI coverage (instead of dividing the number of coverage by the length of epidemic, it's divided by the length of (non-missing) estimated Rt).

# Data examples

Before we look into the experimental results. Let's see an example of CI coverage for each scenario by each method first.

```{r dat-example, echo=FALSE}
# generate a random sample for each setting (of Rt scenario, incidence distribution, serial interval distribution)
dat1_pois_measles <- data_generator(Rt_case = 1, dist = "poisson", si_type = "measles", seed = 9)
dat2_pois_measles <- data_generator(Rt_case = 2, dist = "poisson", si_type = "measles", seed = 4)
dat3_pois_measles <- data_generator(Rt_case = 3, dist = "poisson", si_type = "measles", seed = 9)
dat4_pois_measles <- data_generator(Rt_case = 4, dist = "poisson", si_type = "measles", seed = 4)
dat1_NB_measles <- data_generator(Rt_case = 1, dist = "NB", si_type = "measles", seed = 3)
dat2_NB_measles <- data_generator(Rt_case = 2, dist = "NB", si_type = "measles", seed = 5)
dat3_NB_measles <- data_generator(Rt_case = 3, dist = "NB", si_type = "measles", seed = 6)
dat4_NB_measles <- data_generator(Rt_case = 4, dist = "NB", si_type = "measles", seed = 4)
dat1_pois_SARS <- data_generator(Rt_case = 1, dist = "poisson", si_type = "SARS", seed = 792)
dat2_pois_SARS <- data_generator(Rt_case = 2, dist = "poisson", si_type = "SARS", seed = 1)
dat3_pois_SARS <- data_generator(Rt_case = 3, dist = "poisson", si_type = "SARS", seed = 792)
dat4_pois_SARS <- data_generator(Rt_case = 4, dist = "poisson", si_type = "SARS", seed = 3)
dat1_NB_SARS <- data_generator(Rt_case = 1, dist = "NB", si_type = "SARS", seed = 86)
dat2_NB_SARS <- data_generator(Rt_case = 2, dist = "NB", si_type = "SARS", seed = 5)
dat3_NB_SARS <- data_generator(Rt_case = 3, dist = "NB", si_type = "SARS", seed = 37)
dat4_NB_SARS <- data_generator(Rt_case = 4, dist = "NB", si_type = "SARS", seed = 29)

# combine the random samples as a data table  
dat_example <- data.table(incidence = c(dat1_pois_measles$incidence, 
                                        dat2_pois_measles$incidence,
                                        dat3_pois_measles$incidence,
                                        dat4_pois_measles$incidence,
                                        dat1_NB_measles$incidence,
                                        dat2_NB_measles$incidence,
                                        dat3_NB_measles$incidence,
                                        dat4_NB_measles$incidence,
                                        dat1_pois_SARS$incidence,
                                        dat2_pois_SARS$incidence,
                                        dat3_pois_SARS$incidence,
                                        dat4_pois_SARS$incidence,
                                        dat1_NB_SARS$incidence,
                                        dat2_NB_SARS$incidence,
                                        dat3_NB_SARS$incidence,
                                        dat4_NB_SARS$incidence),
                          trueRt = rep(c(dat1_pois_measles$Rt,
                                         dat2_pois_measles$Rt,
                                         dat3_pois_measles$Rt,
                                         dat4_pois_measles$Rt), 4),
                          time = rep(1:300, 4 * 4),
                          Rt_case = rep(rep(1:4, each = 300), 4),
                          dist = rep(rep(c("Poisson", "Negative Binomial"), each = 300 * 4), 2),
                          si_type = rep(c("measles", "SARS"), each = 4 * 300 * 2)
                          )

# display each setting of the random samples
dat_example %>%
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "measles") %>%
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x, y = incidence)) +
  geom_line() + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Incidence of measles epidemics") +
  theme_bw()
  
dat_example %>%
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>%
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x, y = incidence)) +
  geom_line() + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Incidence of SARS epidemics") +
  theme_bw()
```

For each case, the fitted Rt and corresponding 95% confidence bands are below.

```{r ci-example-function-prep, include=FALSE}
example_producer <- function(method) {
  Rtfitted1_pois_measles <- problem_solver(method = method, instance = dat1_pois_measles)
  Rtfitted2_pois_measles <- problem_solver(method = method, instance = dat2_pois_measles)
  Rtfitted3_pois_measles <- problem_solver(method = method, instance = dat3_pois_measles)
  Rtfitted4_pois_measles <- problem_solver(method = method, instance = dat4_pois_measles)
  
  Rtfitted1_NB_measles <- problem_solver(method = method, instance = dat1_NB_measles)
  Rtfitted2_NB_measles <- problem_solver(method = method, instance = dat2_NB_measles)
  Rtfitted3_NB_measles <- problem_solver(method = method, instance = dat3_NB_measles)
  Rtfitted4_NB_measles <- problem_solver(method = method, instance = dat4_NB_measles)
  
  Rtfitted1_pois_SARS <- problem_solver(method = method, instance = dat1_pois_SARS)
  Rtfitted2_pois_SARS <- problem_solver(method = method, instance = dat2_pois_SARS)
  Rtfitted3_pois_SARS <- problem_solver(method = method, instance = dat3_pois_SARS)
  Rtfitted4_pois_SARS <- problem_solver(method = method, instance = dat4_pois_SARS)
  
  Rtfitted1_NB_SARS <- problem_solver(method = method, instance = dat1_NB_SARS)
  Rtfitted2_NB_SARS <- problem_solver(method = method, instance = dat2_NB_SARS)
  Rtfitted3_NB_SARS <- problem_solver(method = method, instance = dat3_NB_SARS)
  Rtfitted4_NB_SARS <- problem_solver(method = method, instance = dat4_NB_SARS)

  ResDat <- data.table(
    fitted_Rt = c(Rtfitted1_pois_measles$fitted_Rt, 
                  Rtfitted2_pois_measles$fitted_Rt,
                  Rtfitted3_pois_measles$fitted_Rt,
                  Rtfitted4_pois_measles$fitted_Rt,
                  Rtfitted1_NB_measles$fitted_Rt,
                  Rtfitted2_NB_measles$fitted_Rt,
                  Rtfitted3_NB_measles$fitted_Rt,
                  Rtfitted4_NB_measles$fitted_Rt,
                  Rtfitted1_pois_SARS$fitted_Rt,
                  Rtfitted2_pois_SARS$fitted_Rt,
                  Rtfitted3_pois_SARS$fitted_Rt,
                  Rtfitted4_pois_SARS$fitted_Rt,
                  Rtfitted1_NB_SARS$fitted_Rt,
                  Rtfitted2_NB_SARS$fitted_Rt,
                  Rtfitted3_NB_SARS$fitted_Rt,
                  Rtfitted4_NB_SARS$fitted_Rt),
    lower_bound = c(Rtfitted1_pois_measles$lower_bound, 
                  Rtfitted2_pois_measles$lower_bound,
                  Rtfitted3_pois_measles$lower_bound,
                  Rtfitted4_pois_measles$lower_bound,
                  Rtfitted1_NB_measles$lower_bound,
                  Rtfitted2_NB_measles$lower_bound,
                  Rtfitted3_NB_measles$lower_bound,
                  Rtfitted4_NB_measles$lower_bound,
                  Rtfitted1_pois_SARS$lower_bound,
                  Rtfitted2_pois_SARS$lower_bound,
                  Rtfitted3_pois_SARS$lower_bound,
                  Rtfitted4_pois_SARS$lower_bound,
                  Rtfitted1_NB_SARS$lower_bound,
                  Rtfitted2_NB_SARS$lower_bound,
                  Rtfitted3_NB_SARS$lower_bound,
                  Rtfitted4_NB_SARS$lower_bound),
    upper_bound = c(Rtfitted1_pois_measles$upper_bound, 
                  Rtfitted2_pois_measles$upper_bound,
                  Rtfitted3_pois_measles$upper_bound,
                  Rtfitted4_pois_measles$upper_bound,
                  Rtfitted1_NB_measles$upper_bound,
                  Rtfitted2_NB_measles$upper_bound,
                  Rtfitted3_NB_measles$upper_bound,
                  Rtfitted4_NB_measles$upper_bound,
                  Rtfitted1_pois_SARS$upper_bound,
                  Rtfitted2_pois_SARS$upper_bound,
                  Rtfitted3_pois_SARS$upper_bound,
                  Rtfitted4_pois_SARS$upper_bound,
                  Rtfitted1_NB_SARS$upper_bound,
                  Rtfitted2_NB_SARS$upper_bound,
                  Rtfitted3_NB_SARS$upper_bound,
                  Rtfitted4_NB_SARS$upper_bound),
    method
    )
  return(ResDat)
}
```

```{r get-ci-example-dat}
res_dat_EpiEstimWeek <- example_producer("EpiEstim(week)")
res_dat_EpiEstimMonth <- example_producer("EpiEstim(month)")

colnames(res_dat_EpiEstimWeek) <- paste(colnames(res_dat_EpiEstimWeek), "EpiEstimWeek", sep="_")
colnames(res_dat_EpiEstimMonth) <- paste(colnames(res_dat_EpiEstimMonth), "EpiEstimMonth", sep="_")

data.table(dat_example, res_dat_EpiEstimWeek) %>%
  filter(fitted_Rt_EpiEstimWeek > 0) %>% # the first few days are too large for EpiLPS, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_EpiEstimWeek), color = "#E69F00") +
  geom_ribbon(aes(ymin = lower_bound_EpiEstimWeek, ymax = upper_bound_EpiEstimWeek), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by EpiEstim (weekly) with SARS incidence") +
  theme_bw()

data.table(dat_example, res_dat_EpiEstimMonth) %>%
  filter(fitted_Rt_EpiEstimMonth > 0) %>% # the first few days are too large for EpiLPS, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_EpiEstimMonth), color = "#F0E442") +
  geom_ribbon(aes(ymin = lower_bound_EpiEstimMonth, ymax = upper_bound_EpiEstimMonth), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by EpiEstim (monthly) with SARS incidence") +
  theme_bw()

```


```{r EpiLPS-ci-example}
res_dat_EpiLPS <- example_producer("EpiLPS")
colnames(res_dat_EpiLPS) <- paste(colnames(res_dat_EpiLPS), "EpiLPS", sep="_")

data.table(dat_example, res_dat_EpiLPS) %>%
  filter(x > 14) %>% # the first few days are too large, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_EpiLPS), color = "#009E73") +
  geom_ribbon(aes(ymin = lower_bound_EpiLPS, ymax = upper_bound_EpiLPS), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by EpiLPS with SARS incidence") +
  theme_bw()
```  
  


```{r EpiFilter-ci-example}
res_dat_EpiFilter <- example_producer("EpiFilter")
colnames(res_dat_EpiFilter) <- paste(colnames(res_dat_EpiFilter), "EpiFilter", sep="_")

data.table(dat_example, res_dat_EpiFilter) %>%
  filter(x > 14) %>% # the first few days are too large for EpiLPS, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_EpiFilter), color = "#D55E00") +
  geom_ribbon(aes(ymin = lower_bound_EpiFilter, ymax = upper_bound_EpiFilter), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by EpiFilter with SARS incidence") +
  theme_bw()
```

```{r RtEstim-ci-example}
res_dat_RtEstim0 <- example_producer("RtEstim(k=0)")
res_dat_RtEstim1 <- example_producer("RtEstim(k=1)")
res_dat_RtEstim2 <- example_producer("RtEstim(k=2)")
res_dat_RtEstim3 <- example_producer("RtEstim(k=3)")

colnames(res_dat_RtEstim0) <- paste(colnames(res_dat_RtEstim0), "RtEstim0", sep="_")
colnames(res_dat_RtEstim1) <- paste(colnames(res_dat_RtEstim1), "RtEstim1", sep="_")
colnames(res_dat_RtEstim2) <- paste(colnames(res_dat_RtEstim2), "RtEstim2", sep="_")
colnames(res_dat_RtEstim3) <- paste(colnames(res_dat_RtEstim3), "RtEstim3", sep="_")

# k=0
data.table(dat_example, res_dat_RtEstim0) %>%
  filter(x > 14) %>% # the first few days are too large for EpiLPS, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_RtEstim0), color = "#CC79A7") +
  geom_ribbon(aes(ymin = lower_bound_RtEstim0, ymax = upper_bound_RtEstim0), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by RtEstim (k=0) with SARS incidence") +
  theme_bw()

# k=1
data.table(dat_example, res_dat_RtEstim1) %>%
  filter(x > 14) %>% # the first few days are too large for EpiLPS, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_RtEstim1), color = "#0072B2") +
  geom_ribbon(aes(ymin = lower_bound_RtEstim1, ymax = upper_bound_RtEstim1), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by RtEstim (k=1) with SARS incidence") +
  theme_bw()

# k=2
data.table(dat_example, res_dat_RtEstim2) %>%
  filter(x > 14) %>% # the first few days are too large for EpiLPS, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_RtEstim2), color = "#b44582") +
  geom_ribbon(aes(ymin = lower_bound_RtEstim2, ymax = upper_bound_RtEstim2), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by RtEstim (k=2) with SARS incidence") +
  theme_bw()

# k=3
data.table(dat_example, res_dat_RtEstim3) %>%
  filter(x > 14) %>% # the first few days are too large for EpiLPS, CI is very narrow
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  filter(si_type == "SARS") %>% # or "measles"
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(y = fitted_Rt_RtEstim3), color = "#56B4E9") +
  geom_ribbon(aes(ymin = lower_bound_RtEstim3, ymax = upper_bound_RtEstim3), alpha = 0.2) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Rt by RtEstim (k=3) with SARS incidence") +
  theme_bw()
```

# Experimental results

Here we load and refactorize the results:
```{r exp-res-data}
library(forcats)
Rt_result <- readRDS(here::here("dat/rt_cluster_ci_results108.RDS"))
cbPalette <- c("#E69F00","#F0E442", "#009E73", "#D55E00", 
               "#CC79A7", "#0072B2", "#b44582", "#56B4E9")
Rt_result <- Rt_result %>%
  mutate(method = fct_recode(
    method,
    "EpiEstim (weekly)" = "EpiEstim(week)",
    "EpiEstim (monthly)" = "EpiEstim(month)",
    "RtEstim (k=0)" = "RtEstim(k=0)",
    "RtEstim (k=1)" = "RtEstim(k=1)",
    "RtEstim (k=2)" = "RtEstim(k=2)",
    "RtEstim (k=3)" = "RtEstim(k=3)"
  )) %>%
  mutate(method = fct_relevel(
    method, 
    "EpiEstim (weekly)", 
    "EpiEstim (monthly)", 
    "EpiLPS", 
    "EpiFilter",
    "RtEstim (k=0)", 
    "RtEstim (k=1)", 
    "RtEstim (k=2)", 
    "RtEstim (k=3)"
  )) %>%
  mutate(dist = fct_recode(
    dist,
    "Poisson" = "poisson",
    "Negative Binomial" = "NB"
  )) %>%
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  ))

# compute the sequence length of CI coverage for each experiment
ci_len <- double(nrow(Rt_result))
for(i in 1:nrow(Rt_result)) {
  ci_len[i] <- length(Rt_result[i,]$ci_coverage[[1]])
}
Rt_result <- data.table(Rt_result, ci_len)
```

## Percentage of CI coverage

Here we visualize the percentage of CIs containing the true Rt of all observations across all methods and all scenarios. 
Each box in the figures below displays the percentage of CI coverage for each method under each scenario. 

```{r exp-res-ci-percentage}
Rt_result %>% 
  #filter(method != "EpiEstim(month)") %>%
  #filter(method != "EpiLPS") %>%
  filter(si_type == "measles") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_percentage, x = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  geom_hline(yintercept = 0.95, color = "orange", linetype = "dashed") + 
  labs(x = "Methods", y = "CI percentages of coverage for measles epidemics") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL))

Rt_result %>% 
  #filter(method != "EpiEstim(month)") %>%
  #filter(method != "EpiLPS") %>%
  filter(si_type == "SARS") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_percentage, x = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  geom_hline(yintercept = 0.95, color = "orange", linetype = "dashed") + 
  labs(x = "Methods", y = "CI percentages of coverage for SARS epidemics") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), legend.position = "bottom")
```

## CI coverage averaged across replicates

CI coverage for measles epidemics averaged through 50 random samples are 
all displayed in the following figure.

```{r exp-res-ci-coverage}
Rt_res_ci <- Rt_result %>%
  select(si_type, ci_len, dist, Rt_case, method, ci_coverage) %>%
  group_by(si_type, dist, Rt_case, method) %>%
  unnest_wider(ci_coverage, names_sep = "")

# replace NAs with negative values
columns_to_replace <- paste0("ci_coverage", 1:300)
Rt_res_ci_noNAs <- Rt_res_ci %>%
  mutate_at(vars(columns_to_replace), list(~ replace_na(., -1)))
Rt_res_ci_noNAs <- Rt_res_ci_noNAs %>% 
  group_by(si_type, ci_len, dist, Rt_case, method) %>%
  summarize(across(all_of(columns_to_replace), mean)) %>%
  pivot_longer(cols = columns_to_replace, names_to = "index", values_to = "ci_coverage") %>%
  mutate(index = as.numeric(gsub("\\D", "", index))) %>%
  mutate(time_index = 300 - ci_len + index) %>%
  group_by(dist, method, Rt_case) %>%
  filter(ci_coverage >= 0) 

Rt_res_ci_noNAs %>% # exclude NAs for certain methods
  filter(si_type == "measles") %>% # SARS
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette) + 
  labs(y = "CI coverage for measles epidemics") + 
  theme_bw() +
  theme(legend.position = "bottom") 
```

Generally, coverage is better for Poisson incidence with all Rt cases across all methods. EpiEstim with monthly sliding window does not work well for most cases. 
Confidence bands of EpiFilter and RtEstim (k=0) do not work well for negative Binomial incidence. 
Let's exclude some messy curves to better uncover the meaning information.

Let's focus on RtEstim first. CIs of constant Rt's do not work well even for the piecewise constant Rt scenario (Scenario 1). Referring to the data example in the previous section, the reason for this low coverage is the width of confidence band is too narrow. So it fails to cover the true value, if the fitted Rt just slightly deviates from the true one. 
CIs of RtEstim (k=0) barely cover true Rt's for negative Binomial incidence cases. 
k=1,2,3 look pretty good for measles epidemics. Negative Binomial cases show slightly worse coverage with larger discrepancy around the changepoints. 
SARS epidemics with larger incidence are more difficult, especially with negative Binomial incidence.

```{r exp-res-ci-coverage-RtEstim-subset}
Rt_res_ci_noNAs %>% 
  filter(si_type == "measles") %>%
  filter(method %in% c("RtEstim (k=0)", "RtEstim (k=1)", "RtEstim (k=2)", "RtEstim (k=3)")) %>%
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[5:8]) + 
  labs(y = "Percentages of CI coverage for measles epidemics") + 
  theme_bw() +
  theme(legend.position = "bottom") 

Rt_res_ci_noNAs %>% 
  filter(si_type == "SARS") %>% 
  filter(method %in% c("RtEstim (k=0)", "RtEstim (k=1)", "RtEstim (k=2)", "RtEstim (k=3)")) %>%
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[5:8]) + 
  labs(y = "Percentages of CI coverage for SARS epidemics") + 
  theme_bw() + 
  theme(legend.position = "bottom") 
```

Then, we visualize the curves of competitors. 
For measles epidemics, EpiEstim (weekly) and EpiFilter seem acceptable for Rt scenarios 1-3 with Poisson incidence. 
Across 50 replicates, it covers true Rt at most timepoints, while fails to cover the changepoints. 
All methods, except for EpiLPS, don't work well for negative Binomial incidence. 
For SARS epidemics, 

```{r exp-res-ci-coverage-competitors-subset}
Rt_res_ci_noNAs %>% 
  filter(si_type == "measles") %>%
  filter(!method %in% c("RtEstim (k=0)", "RtEstim (k=1)", "RtEstim (k=2)", "RtEstim (k=3)")) %>%
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[1:4]) + 
  labs(y = "Percentages of CI coverage for measles epidemics") + 
  theme_bw() + 
  theme(legend.position = "bottom") 

Rt_res_ci_noNAs %>% 
  filter(si_type == "SARS") %>% 
  filter(!method %in% c("RtEstim (k=0)", "RtEstim (k=1)", "RtEstim (k=2)", "RtEstim (k=3)")) %>%
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[1:4]) + 
  labs(y = "Percentages of CI coverage for SARS epidemics") + 
  theme_bw() + 
  theme(legend.position = "bottom") 
```

Let's put together RtEstim with k=1,2,3 and EpiLPS. EpiLPS seems to fail at the beginning of epidemics, 
it's consistent to the results of the fitted Rt's, which can be unreasonably large. 
In negative Binomial cases, EpiLPS works the best, which makes sense, since it uses the negative Binomial distributional assumption of incidence.

```{r exp-res-ci-coverage-compare-subset}
Rt_res_ci_noNAs %>% 
  filter(si_type == "measles") %>%
  filter(method %in% c("RtEstim (k=1)", "RtEstim (k=2)", "RtEstim (k=3)", "EpiLPS")) %>%
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[c(3, 5:8)]) + 
  labs(y = "Percentages of CI coverage for measles epidemics") + 
  theme_bw() + 
  theme(legend.position = "bottom") 

Rt_res_ci_noNAs %>% 
  filter(si_type == "SARS") %>% 
  filter(method %in% c("RtEstim (k=1)", "RtEstim (k=2)", "RtEstim (k=3)", "EpiLPS")) %>%
  filter(method != "EpiEstim (monthly)") %>%
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[c(3, 6:8)]) + 
  labs(y = "Percentages of CI coverage for SARS epidemics") + 
  theme_bw() + 
  theme(legend.position = "bottom") 
```

## Interval scores

Interval scores give supplementary information on CIs. Though EpiLPS performs the best 
in coverage of true Rt's, it tends to be too wide to be informative due to surprisingly large interval scores.

```{r exp-res-interval-score}
Rt_result %>% 
  filter(method != "EpiLPS") %>% # too large
  filter(si_type == "measles") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_score, x = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  scale_y_log10() +
  labs(x = "Methods", y = "Interval scores") + 
  theme_bw() + 
  labs(y = "Interval scores for measles epidemics") + 
  theme(axis.text.x = element_blank(), legend.position = "bottom")

Rt_result %>% 
  filter(method != "EpiLPS") %>% # too large
  filter(si_type == "SARS") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_score, x = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  scale_y_log10() +
  labs(x = "Methods", y = "Interval scores") + 
  theme_bw() + 
  labs(y = "Interval scores for SARS epidemics") + 
  theme(axis.text.x = element_blank(), legend.position = "bottom")
```

# References

<div id="refs"></div>
