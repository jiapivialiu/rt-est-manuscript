---
title: "Supplementary details on experiments of effective reproduction number estimation with trend filtering"
author: "Jiaping Liu, Zhenglun Cai, Paul Gustafson, and Daniel J. McDonald"
date: "`r Sys.Date()`"
output: 
  pdf_document: 
    includes:
      in_header: 
        - "header.tex"
        - "defs.tex"
    number_sections: true
    fig_caption: yes
header-includes:
  - \usepackage{caption}
  - \captionsetup[figure]{labelformat=empty}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rtestim)
library(EpiEstim)
library(EpiLPS)
library(data.table)
library(tidyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(forcats)
library(lubridate)
library(ggpubr)
```

# Supplementary details on experimental settings of RtEstim for Section 3.1

We run 10-fold cross validation (CV) to choose the best tuning parameter
from the candidate set of size $50$, i.e., $\boldsymbol{\lambda} = \{\lambda_1,
\cdots, \lambda_{50}\}$. Specifically, we divide the all samples (except the 
first and last entries) into ten folds evenly and randomly, and build models on 
each sample set by leaving a fold out across all hyperparameters. We select the 
tuning parameter that gives the lowest averaged ***deviance*** between the 
estimated reproduction numbers and the observed samples averaged over all folds. 

# Supplementary results of experiments for Fig 3 in Section 3.2

The full KL divergence values for Poisson incidence without excluding the 
outliers are shown in Fig 10. Y-axis is displayed on a logarithmic scale for a 
better visualization, since a few values are much larger than others. 

Comparing among Rt estimations by EpiLPS, RtEstim and EpiEstim with ***weekly***
sliding windows, KL values computation excludes the first week of Rt estimates 
for all approaches. The outliers are mainly EpiLPS and EpiEstim Rt estimations 
in Scenario 2, which is generally an easy problem except for the changepoint at
where the two segments are discontinuous. Since EpiEstim produces a continuous Rt 
curve, the changepoint can be difficult to recover and make estimation less 
accurate.

```{r load-simulation-results, include=FALSE}
cbPalette <- c(
  "#E69F00", "#F0E442", "#009E73", "#CC79A7", "#0072B2", "#56B4E9"
)
Rt_result <- readRDS(here::here("dat/rt_exp_results.RDS"))
Rt_result$Rt_case <- as.factor(Rt_result$Rt_case)
Rt_result$dist <- as.factor(Rt_result$dist)
Rt_result$method <- as.factor(Rt_result$method)
n <- dim(Rt_result)[1]
Rt_result <- Rt_result %>%
  select(method, Rt_case, dist, runtime, Rt_kl, Rt_kl_month) %>%
  mutate(method = fct_recode(method,
    "EpiEstim (weekly)" = "EpiEstim(week)",
    "EpiEstim (monthly)" = "EpiEstim(month)",
    "RtEstim (k=0)" = "RtEstim(k=0)",
    "RtEstim (k=1)" = "RtEstim(k=1)",
    "RtEstim (k=3)" = "RtEstim(k=3)"
  )) %>%
  mutate(method = fct_relevel(
    method, "EpiEstim (weekly)", "EpiEstim (monthly)",
    "EpiLPS", "RtEstim (k=0)", "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  mutate(dist = fct_recode(dist,
    "Poisson" = "poisson",
    "Negative Binomial" = "NB"
  )) %>%
  mutate(dist = fct_relevel(dist, "Poisson", "Negative Binomial")) %>%
  mutate(Rt_case = fct_recode(Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) %>%
  mutate(Rt_kl = Rt_kl * n, Rt_kl_month = Rt_kl_month * n)
```

```{r display-KL-weekly-full-res, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "Fig 10. KL divergence for methods with weekly sliding windows. Y-axis is on a logarithmic scale."}
fig_kl_full_week <- Rt_result %>%
  filter(method != "EpiEstim (monthly)") |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl)) + # sum up KL per coordinate
  geom_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[-2]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL))
print(fig_kl_full_week)
```

# Experimental results of methods using monthly sliding windows for Section 3.1

Fig 11 displays the KL divergence values for negative Binomial incidence 
including the outliers. Comparing across Rt estimations by EpiLPS, RtEstim and
EpiEstim with ***monthly*** sliding windows, KL divergece values computation
excludes the first month of Rt estimates for all approaches. 

The relative performance of EpiEstim with monthly sliding windows, in general, 
is not as good as its weekly sliding window based on the relative positions of 
its boxes and the counterparts of the other methods, except for the Scenario 2 
with negative Binomial incidence. A reason is that EpiEstim with longer sliding 
windows assume similarity of neighboring Rt across longer periods, and thus,
is smoother and less accurate compared to the one with shorter sliding windows. 

```{r display-KL-monthly-full-res, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "Fig 11. KL divergence for methods with monthly sliding windows. Y-axis is on a logarithmic scale."}
fig_kl_full_month <- Rt_result %>%
  filter(method != "EpiEstim (weekly)") |>
  mutate(method = fct_relevel(
    method, "EpiEstim (monthly)",
    "EpiLPS", "RtEstim (k=0)", "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl_month)) + # sum up KL per coordinate
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[-1]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL))
print(fig_kl_full_month)
```

# Time comparisons of methods for Section 3.2

Fig 12 shows the time comparisons across all methods. EpiEstim with both weekly 
and monthly sliding windows are very fast and converge in less than 0.1 seconds.
Piecewise constant RtEstim (with k=0) estimates can be generated within 0.1 
seconds as well. EpiLPS is slightly slower, but still very fast and within 1 
second for all experiments. Piecewise linear and cubic RtEstim (with k=1 and 3 
respectively) are slower, but mostly within 10 seconds. 

It is remarkable that our RtEstim computes 50 lambda values with 10-fold CV for 
each experiment, which results in 500 times of modelling per experiment. The 
running times are no more than 10 seconds for most of the experiments, which 
means the running time for each time of modelling is very fast, and on average 
can be less than 0.02 seconds. The other two methods only run once for a fixed 
set of hyperparameters for each experiment. 

```{r display-simulation-time-comparison, echo = FALSE, fig.height = 7, fig.width = 6.6, fig.cap = "Fig 12. Time comparisons of methods (excluding one outlier of `RtEstim (k=1)` in Scenario 2 with negative Binomial incidence). Y-axis is on a logarithmic scale."}
runtime_fig <- Rt_result %>%
  filter(runtime <= 80 * 1e6) %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(x = Rt_case, y = runtime / 1e6)) +
  geom_boxplot(aes(col = method)) +
  facet_wrap(vars(dist)) +
  scale_colour_manual(values = cbPalette) +
  scale_y_log10() +
  labs(y = "Running time in seconds", x = "Rt scenarios") +
  labs(color = "Methods") +
  theme_bw() +
  theme(legend.position = "bottom")
print(runtime_fig)
```

<!-- The following R chunks are used for reproduce figures in the main manuscript. -->

```{r Fig1-display-cancovid-example, eval=FALSE, include=FALSE}
library(rtestim)
cancovid <- cancovid[-1:-65, ] # drop the beginning period
n <- nrow(cancovid)

# plot fitted Rt with confidence band
cv_mod <- cv_estimate_rt(
  x = cancovid$date, cancovid$incident_cases, korder = 2, nfold = 10,
  maxiter = 1e7L, nsol = 50, error_measure = "deviance",
  lambda_min_ratio = 1e-6, init = configure_rt_admm(tol = 1e-6)
)
rt_ci_covid <- confband(cv_mod, "lambda.1se") # get 95% confidence band
fig_rt_fit <- rt_ci_covid %>%
  ggplot(aes(x = cancovid$date)) +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), fill = "gray", alpha = 0.5) +
  geom_line(aes(y = Rt), col = "#0072B2", lwd = 1) +
  scale_x_date(date_breaks = "8 months", date_labels = "%Y-%m-%d") +
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(x = "Date", y = "Piecewise quadratic Rt with 95% CIs") +
  theme_bw()

# plot fitted incidence
mod_best <- estimate_rt(
  x = cancovid$date, cancovid$incident_cases, korder = 2, maxiter = 1e7L,
  lambda = cv_mod$lambda.1se
)
incidence_fit <- mod_best$weighted_past_counts * rt_ci_covid$Rt
inc_dat <- data.table(cancovid, incidence_fit = incidence_fit)
fig_inc_fit <- inc_dat %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = incident_cases / 10000)) +
  geom_line(aes(y = incidence_fit / 10000), col = "#D55E00", lwd = 1) +
  scale_x_date(date_breaks = "8 months", date_labels = "%Y-%m-%d") +
  labs(x = "Date", y = "Fitted incidence (per 10,000)") +
  theme_bw()

CANCovid_fig <- ggarrange(
  fig_rt_fit, fig_inc_fit,
  ncol = 1, common.legend = TRUE, legend = "bottom"
)
print(CANCovid_fig)
```

```{r Fig2-generate-poisson-examples, eval = FALSE, include = FALSE}
# General settings:
N1 <- 2 # first incidence data
len <- 300 # number of evenly spaced time points
library(rtestim)
# Get Poisson incidence cases:
get_pois_incidence <- function(N1, Rt, gamma_pars = c(2.5, 2.5)) {
  len <- length(Rt)
  incidence <- numeric(len) # N_1:n
  poisson_count <- numeric(len) # y_1:n
  incidence[1] <- N1

  poisson_count[1] <- rpois(1, N1)
  if (poisson_count[1] == 0) poisson_count[1] <- 1
  for (t in 2:len) {
    pi <- discretize_gamma(1:(t - 1), gamma_pars[1], gamma_pars[2])
    incidence[t] <- Rt[t] * sum(rev(pi) * poisson_count[1:(t - 1)])
    poisson_count[t] <- rpois(1, incidence[t])
  }

  return(poisson_count)
}
# Display the synthetic data:
display_dat <- function(counts, Rt) {
  len <- length(counts)
  if (length(counts) != length(Rt)) cli::cli_abort("Data lengths do not match.")
  dat <- data.frame(time = 1:len, count = counts, Rt = Rt)
  fig1 <- dat %>%
    ggplot(aes(y = Rt, x = time)) +
    geom_line() +
    theme_bw()
  print(fig1)
  fig2 <- dat %>%
    ggplot(aes(y = count, x = time)) +
    geom_line() +
    # scale_y_log10() + # axis of incidence in log scale
    ylab("Poisson incidence data") + # (in log scale)
    theme_bw()
  print(fig2)
}
# Check data quality:
check_dat <- function(incidence, Rt) {
  if (min(Rt) < 0) {
    cli::cli_abort("`Rt` must be non-negative.")
  }
  if (min(incidence) < 0) {
    cli::cli_abort("`incidence` cases must be nonnegative.")
  }
  if (max(incidence) > 1e4L) {
    cli::cli_alert_warning("`incidence` cases are too large.")
  }
  if (sum(incidence == 0) > 30) {
    cli::cli_warn("`incidence` data has more than 10% 0s.")
  }
}

seed <- 420
# Scenario 1: piecewise constant with one dropping point
Rt1 <- c(rep(2, 70), rep(0.8, len - 70))
gamma_pars1 <- c(3, 3) # serial interval distribution parameters
set.seed(seed)
incidence1 <- get_pois_incidence(N1, Rt1, gamma_pars1)
# display_dat(incidence1, Rt1)
# check_dat(incidence1, Rt1)

# Scenario 2: piecewise exponential
rate <- c(.015, -.005)
Rt2 <- numeric(len)
knot <- 50
Rt2[1:knot] <- exp(rate[1] * (1:knot))
Rt2[(knot + 1):len] <- exp((rate[2]) * ((knot + 1):len)) * Rt2[knot]
gamma_pars2 <- c(2.5, 2.5) # serial interval distribution parameters
set.seed(seed)
incidence2 <- get_pois_incidence(N1, Rt2, gamma_pars2)

# Scenario 3: multi-stage piecewise linear
Rt3 <- c(
  seq(2.5, 2, length.out = 60), seq(0.8, 0.6, length.out = 50),
  seq(1.7, 2, length.out = 40), seq(0.9, 0.5, length.out = 150)
)
gamma_pars3 <- c(3.5, 3.5) # serial interval distribution parameters
set.seed(seed)
incidence3 <- get_pois_incidence(N1, Rt3, gamma_pars3)

# Scenario 4: multi-stage with exponential-sinusoidal growth and decay
x <- seq(0, 10, length.out = len)
Rt4 <- numeric(len)
components <- list(
  list(freq = 0.1, amp = 1),
  list(freq = 0.5, amp = 2),
  list(freq = 1.0, amp = 3)
)
for (component in components) {
  Rt4 <- Rt4 + 0.2 * (component$amp * sin(pi * component$freq * x / 1.2) +
    component$amp)
}
gamma_pars4 <- c(3.5, 3.5) # serial interval distribution parameters
set.seed(seed)
incidence4 <- get_pois_incidence(N1, Rt4, gamma_pars4)
```

```{r Fig2-generate-NB-examples, eval = FALSE, include = FALSE}
get_nb_incidence <- function(N1, Rt, gamma_pars = c(2.5, 2.5)) {
  len <- length(Rt)
  incidence <- numeric(len) # N_1:n
  NB_count <- numeric(len) # y_1:n
  incidence[1] <- N1
  size <- 5

  NB_count[1] <- rnbinom(1, mu = N1, size = size)
  if (NB_count[1] == 0) NB_count[1] <- 1
  for (t in 2:len) {
    pi <- discretize_gamma(1:(t - 1), gamma_pars[1], gamma_pars[2])
    incidence[t] <- Rt[t] * sum(rev(pi) * NB_count[1:(t - 1)])
    NB_count[t] <- rnbinom(1, mu = incidence[t], size = size)
  }

  return(NB_count)
}
# scenario 1
seed <- 525
set.seed(seed)
nb_incidence1 <- get_nb_incidence(N1, Rt1, gamma_pars1)
# scenario 2
set.seed(seed)
nb_incidence2 <- get_nb_incidence(N1, Rt2, gamma_pars2)
# scenario 3
set.seed(seed)
nb_incidence3 <- get_nb_incidence(N1, Rt3, gamma_pars3)
# scenario 4
set.seed(seed)
nb_incidence4 <- get_nb_incidence(N1, Rt4, gamma_pars4)
```

```{r Fig2-display-examples, eval = FALSE, include = FALSE}
sample_dat <- data.table(
  time = 1:len, Rt1 = Rt1, Rt2 = Rt2, Rt3 = Rt3, Rt4 = Rt4,
  Pois_count1 = incidence1, Pois_count2 = incidence2,
  Pois_count3 = incidence3, Pois_count4 = incidence4,
  NB_count1 = nb_incidence1, NB_count2 = nb_incidence2,
  NB_count3 = nb_incidence3, NB_count4 = nb_incidence4
)

display_example <- function(res_dat) {
  len <- dim(res_dat)[1]
  fig1 <- res_dat %>%
    ggplot(aes(y = Rt1, x = time)) +
    geom_line() +
    labs(y = "Scenario 1", title = "Rt", x = "") +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme_bw()
  fig2 <- res_dat %>%
    ggplot(aes(y = Pois_count1, x = time)) +
    geom_line() +
    labs(title = "Poisson incidence", y = " ", x = "") +
    coord_cartesian(ylim = c(0, 2500)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme_bw()
  fig3 <- res_dat %>%
    ggplot(aes(y = NB_count1, x = time)) +
    geom_line() +
    labs(title = "NB incidence", y = " ", x = "") +
    coord_cartesian(ylim = c(0, 2500)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme_bw()

  fig21 <- res_dat %>%
    ggplot(aes(y = Rt2, x = time)) +
    geom_line() +
    labs(y = "Scenario 2", x = "") +
    theme_bw()
  fig22 <- res_dat %>%
    ggplot(aes(y = Pois_count2, x = time)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 3000)) +
    labs(y = " ", x = "") +
    theme_bw()
  fig23 <- res_dat %>%
    ggplot(aes(y = NB_count2, x = time)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 3000)) +
    labs(y = " ", x = "") +
    theme_bw()

  fig31 <- res_dat %>%
    ggplot(aes(y = Rt3, x = time)) +
    geom_line() +
    labs(y = "Scenario 3", x = "") +
    theme_bw()
  fig32 <- res_dat %>%
    ggplot(aes(y = Pois_count3, x = time)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 1500)) +
    labs(y = " ", x = "") +
    theme_bw()
  fig33 <- res_dat %>%
    ggplot(aes(y = NB_count3, x = time)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 1500)) +
    labs(y = " ", x = "") + # (in log scale)
    theme_bw()

  fig41 <- res_dat %>%
    ggplot(aes(y = Rt4, x = time)) +
    geom_line() +
    labs(y = "Scenario 4") +
    theme_bw()
  fig42 <- res_dat %>%
    ggplot(aes(y = Pois_count4, x = time)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 4000)) +
    labs(y = " ") +
    theme_bw()
  fig43 <- res_dat %>%
    ggplot(aes(y = NB_count4, x = time)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 4000)) +
    labs(y = " ") +
    theme_bw()

  figfull <- ggpubr::ggarrange(fig1, fig2, fig3,
    fig21, fig22, fig23,
    fig31, fig32, fig33,
    fig41, fig42, fig43,
    ncol = 3, nrow = 4,
    common.legend = TRUE, legend = "bottom"
  )
  print(figfull)
}

display_example(sample_dat)
```

```{r Fig3-display-simulation-results, eval = FALSE, include = FALSE}
# exclude the extremely large KL values
Rt_result_no_outliers <- Rt_result |>
  filter(method != "EpiEstim (monthly)") |>
  select(Rt_case, dist, method, Rt_kl) |>
  group_by(Rt_case, dist, method) |>
  mutate(big_out = Rt_kl > fivenum(Rt_kl, na.rm = TRUE)[4] +
    1.5 * IQR(Rt_kl, na.rm = TRUE)) |>
  filter(!big_out) |>
  select(!big_out)
Rt_result_no_outliers$Rt_case <- as.factor(Rt_result_no_outliers$Rt_case)
Rt_result_no_outliers$dist <- as.factor(Rt_result_no_outliers$dist)
Rt_result_no_outliers$method <- as.factor(Rt_result_no_outliers$method)

KL_fig_no_outlier <- Rt_result_no_outliers %>%
  ggplot(aes(x = method, y = Rt_kl * 300)) + # sum up KL per coordinate s
  geom_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[-1]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL))
print(KL_fig_no_outlier)
```

```{r Fig4-display-Rt-for-Poisson-incidence, eval = FALSE, include = FALSE}
## Rt estimates for Poisson incidence by all models
## Commands used to visualize fitted Rt are commented.

## RtEstim
# Scenario 1 by RtEstim (k=0)
cv_mod1 <- cv_estimate_rt(
  incidence1,
  korder = 0, nfold = 10, nsol = 50, dist_gamma = gamma_pars1,
  maxiter = 1e7L, error_measure = "deviance"
)
# plot(cv_mod1)
rtestim_tuned_mod1 <- cv_mod1$full_fit$Rt[, which.min(cv_mod1$cv_scores)]
# rt_ci1 <- confband(cv_mod1, "lambda.min") # get 95% confidence band
# rt_ci1 %>%
#  ggplot(aes(x = 1:length(incidence1), y = Rt)) +
#  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`),
#              fill = "gray", alpha = 0.5) +
#  geom_line() +
#  geom_hline(yintercept = 1, linetype = "dotted") +
#  labs(x="Time", y = "RtEstim Rt with 95% CIs") +
#  theme_bw()
# Scenario 2 by RtEstim (k=3)
cv_mod2 <- cv_estimate_rt(
  incidence2,
  korder = 3, nfold = 10, nsol = 50, maxiter = 1e7L,
  dist_gamma = gamma_pars2, error_measure = "deviance"
)
rtestim_tuned_mod2 <- cv_mod2$full_fit$Rt[, which.min(cv_mod2$cv_scores)]
# Scenario 2 by RtEstim (k=1)
cv_mod22 <- cv_estimate_rt(
  incidence2,
  korder = 1, nfold = 10, nsol = 50, maxiter = 1e7L,
  dist_gamma = gamma_pars2, error_measure = "deviance"
)
rtestim_tuned_mod22 <- cv_mod22$full_fit$Rt[, which.min(cv_mod22$cv_scores)]
# Scenario 3 by RtEstim (k=1)
cv_mod3 <- cv_estimate_rt(
  incidence3,
  korder = 1, nfold = 10, nsol = 50, maxiter = 1e7L,
  dist_gamma = gamma_pars3, error_measure = "deviance"
)
rtestim_tuned_mod3 <- cv_mod3$full_fit$Rt[, which.min(cv_mod3$cv_scores)]
# Scenario 4 by RtEstim (k=3)
cv_mod4 <- cv_estimate_rt(
  incidence4,
  korder = 3, nfold = 10, nsol = 50, maxiter = 1e7L,
  dist_gamma = gamma_pars4, error_measure = "deviance"
)
rtestim_tuned_mod4 <- cv_mod4$full_fit$Rt[, which.min(cv_mod4$cv_scores)]

## SI for EpiEstim and EpiLPS
method <- "non_parametric_si"
Dmax1 <- floor(stats::qgamma(0.9999, 3, scale = 3))
prob_gamma1 <- discretize_gamma(1:Dmax1, shape = 3, scale = 3)
Dmax2 <- floor(stats::qgamma(0.9999, 2.5, scale = 2.5))
prob_gamma2 <- discretize_gamma(1:Dmax2, shape = 2.5, scale = 2.5)
Dmax3 <- floor(stats::qgamma(0.9999, 3.5, scale = 3.5))
prob_gamma3 <- discretize_gamma(1:Dmax3, shape = 3.5, scale = 3.5)
prob_gamma4 <- prob_gamma3

## EpiEstim
# configuration for weekly sliding windows
t_week_start <- seq(2, len - 6)
t_week_end <- t_week_start + 6
config_week1 <- make_config(list(
  si_distr = c(0, prob_gamma1),
  t_start = t_week_start,
  t_end = t_week_end
))
config_week2 <- make_config(list(
  si_distr = c(0, prob_gamma2),
  t_start = t_week_start,
  t_end = t_week_end
))
config_week3 <- make_config(list(
  si_distr = c(0, prob_gamma3),
  t_start = t_week_start,
  t_end = t_week_end
))
config_week4 <- config_week3
# Rt estimates
mod_epiEstim_week1 <- EpiEstim::estimate_R(
  incid = incidence1,
  config = config_week1,
  method = method
)
# plot(mod_epiEstim_week1, "R") +
#  labs(y="EpiEstim Rt with weekly window and 95% CIs", title="") +
#  theme_bw() +
#  theme(legend.position = "none")
mod_epiEstim_week2 <- EpiEstim::estimate_R(
  incid = incidence2,
  config = config_week2,
  method = method
)
mod_epiEstim_week3 <- EpiEstim::estimate_R(
  incid = incidence3,
  config = config_week3,
  method = method
)
mod_epiEstim_week4 <- EpiEstim::estimate_R(
  incid = incidence4,
  config = config_week4,
  method = method
)
# configuration for monthly sliding window
t_month_start <- seq(2, len - 29)
t_month_end <- t_month_start + 29
config_month1 <- make_config(list(
  si_distr = c(0, prob_gamma1),
  t_start = t_month_start,
  t_end = t_month_end
))
config_month2 <- make_config(list(
  si_distr = c(0, prob_gamma2),
  t_start = t_month_start,
  t_end = t_month_end
))
config_month3 <- make_config(list(
  si_distr = c(0, prob_gamma3),
  t_start = t_month_start,
  t_end = t_month_end
))
config_month4 <- config_month3
# Rt estimates
mod_epiEstim_month1 <- EpiEstim::estimate_R(
  incid = incidence1,
  config = config_month1,
  method = method
)
mod_epiEstim_month2 <- EpiEstim::estimate_R(
  incid = incidence2,
  config = config_month2,
  method = method
)
mod_epiEstim_month3 <- EpiEstim::estimate_R(
  incid = incidence3,
  config = config_month3,
  method = method
)
mod_epiEstim_month4 <- EpiEstim::estimate_R(
  incid = incidence4,
  config = config_month4,
  method = method
)

## EpiLPS
mod_epilst_pois1 <- estimR(incidence = incidence1, si = prob_gamma1)
# plot(mod_epilst_pois1) +
#  labs(y="EpiLPS Rt with 95% CIs", title="") +
#  theme_bw() +
#  theme(legend.position = "none")
mod_epilst_pois2 <- estimR(incidence = incidence2, si = prob_gamma2)
mod_epilst_pois3 <- estimR(incidence = incidence3, si = prob_gamma3)
mod_epilst_pois4 <- estimR(incidence = incidence4, si = prob_gamma4)

res_dat <- data.table(sample_dat,
  Pois_Epi_week1 = c(rep(NA, 7), mod_epiEstim_week1$R$`Mean(R)`),
  Pois_Epi_week2 = c(rep(NA, 7), mod_epiEstim_week2$R$`Mean(R)`),
  Pois_Epi_week3 = c(rep(NA, 7), mod_epiEstim_week3$R$`Mean(R)`),
  Pois_Epi_week4 = c(rep(NA, 7), mod_epiEstim_week4$R$`Mean(R)`),
  Pois_Epi_month1 = c(rep(NA, 30), mod_epiEstim_month1$R$`Mean(R)`),
  Pois_Epi_month2 = c(rep(NA, 30), mod_epiEstim_month2$R$`Mean(R)`),
  Pois_Epi_month3 = c(rep(NA, 30), mod_epiEstim_month3$R$`Mean(R)`),
  Pois_Epi_month4 = c(rep(NA, 30), mod_epiEstim_month4$R$`Mean(R)`),
  Pois_Rtestim1 = rtestim_tuned_mod1,
  Pois_Rtestim2 = rtestim_tuned_mod2,
  Pois_Rtestim22 = rtestim_tuned_mod22,
  Pois_Rtestim3 = rtestim_tuned_mod3,
  Pois_Rtestim4 = rtestim_tuned_mod4,
  Pois_EpiLPS1 = c(rep(NA, 7), mod_epilst_pois1$RLPS$R[-1:-7]),
  Pois_EpiLPS2 = c(rep(NA, 7), mod_epilst_pois2$RLPS$R[-1:-7]),
  Pois_EpiLPS3 = c(rep(NA, 7), mod_epilst_pois3$RLPS$R[-1:-7]),
  Pois_EpiLPS4 = c(rep(NA, 7), mod_epilst_pois4$RLPS$R[-1:-7])
)

cbPalette2 <- c("#999999", cbPalette[-2])
fig1 <- res_dat %>%
  select(
    time, Rt1, Pois_Epi_week1, Pois_Rtestim1, Pois_Rtestim2, Pois_Rtestim22,
    Pois_EpiLPS1
  ) %>%
  mutate(Pois_Rtestim2 = Pois_Rtestim2 * 1e4L, Pois_Rtestim22 = Pois_Rtestim22 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "True Rt" = "Rt1",
    "RtEstim (k=0)" = "Pois_Rtestim1",
    "RtEstim (k=3)" = "Pois_Rtestim2",
    "RtEstim (k=1)" = "Pois_Rtestim22",
    "EpiEstim" = "Pois_Epi_week1",
    "EpiLPS" = "Pois_EpiLPS1"
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 6)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 1: piecewise constant") +
  theme_bw()

fig2 <- res_dat %>%
  select(
    time, Rt2, Pois_Epi_week2, Pois_Rtestim2, Pois_Rtestim22, Pois_Rtestim1,
    Pois_EpiLPS2
  ) %>%
  mutate(Pois_Rtestim1 = Pois_Rtestim1 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "True Rt" = "Rt2",
    "RtEstim (k=3)" = "Pois_Rtestim2",
    "RtEstim (k=1)" = "Pois_Rtestim22",
    "RtEstim (k=0)" = "Pois_Rtestim1",
    "EpiEstim" = "Pois_Epi_week2",
    "EpiLPS" = "Pois_EpiLPS2"
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 4)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 2: piecewise exponential") +
  theme_bw()

fig3 <- res_dat %>%
  select(
    time, Rt3, Pois_Epi_week3, Pois_Rtestim3, Pois_Rtestim2, Pois_Rtestim1,
    Pois_EpiLPS3
  ) %>%
  mutate(Pois_Rtestim1 = Pois_Rtestim1 * 1e4L, Pois_Rtestim2 = Pois_Rtestim2 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "True Rt" = "Rt3",
    "RtEstim (k=1)" = "Pois_Rtestim3",
    "RtEstim (k=0)" = "Pois_Rtestim1",
    "RtEstim (k=3)" = "Pois_Rtestim2",
    "EpiEstim" = "Pois_Epi_week3",
    "EpiLPS" = "Pois_EpiLPS3"
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  # filter(Rt_type != "EpiLPS") %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 3: piecewise linear") +
  theme_bw()

fig4 <- res_dat %>%
  select(
    time, Rt4, Pois_Epi_week4, Pois_Rtestim4, Pois_Rtestim1, Pois_Rtestim3,
    Pois_EpiLPS4
  ) %>%
  mutate(Pois_Rtestim1 = Pois_Rtestim1 * 1e4L, Pois_Rtestim3 = Pois_Rtestim3 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "True Rt" = "Rt4",
    "RtEstim (k=3)" = "Pois_Rtestim4",
    "RtEstim (k=0)" = "Pois_Rtestim1",
    "RtEstim (k=1)" = "Pois_Rtestim3",
    "EpiEstim" = "Pois_Epi_week4",
    "EpiLPS" = "Pois_EpiLPS4"
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 8)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 4: periodic") +
  theme_bw()

fig_Pois_res <- ggpubr::ggarrange(
  fig1, fig2, fig3, fig4,
  ncol = 2, nrow = 2,
  common.legend = TRUE, legend = "bottom",
  font.label = list(size = 14)
)
fig_Pois_res <- ggpubr::annotate_figure(
  fig_Pois_res,
  left = grid::textGrob("Rt estimates for Poisson incidence",
    rot = 90, vjust = 1, gp = grid::gpar(cex = 1)
  )
)
print(fig_Pois_res)
```

```{r Fig5-display-Rt-for-NB-incidence, eval = FALSE, include = FALSE}
## RtEstim
cv_mod_nb1 <- cv_estimate_rt(
  nb_incidence1,
  korder = 0, nfold = 10, nsol = 50, dist_gamma = c(3, 3),
  error_measure = "deviance"
)
rtestim_tuned_mod_nb1 <- cv_mod_nb1$full_fit$Rt[, which.min(cv_mod_nb1$cv_scores)]
cv_mod_nb2 <- cv_estimate_rt(
  nb_incidence2,
  korder = 3, nfold = 10, nsol = 50, dist_gamma = c(2.5, 2.5),
  error_measure = "deviance"
)
rtestim_tuned_mod_nb2 <- cv_mod_nb2$full_fit$Rt[, which.min(cv_mod_nb2$cv_scores)]
cv_mod_nb22 <- cv_estimate_rt(
  nb_incidence2,
  korder = 1, nfold = 10, nsol = 50, dist_gamma = c(2.5, 2.5),
  error_measure = "deviance"
)
rtestim_tuned_mod_nb22 <- cv_mod_nb22$full_fit$Rt[, which.min(cv_mod_nb22$cv_scores)]
cv_mod_nb3 <- cv_estimate_rt(
  nb_incidence3,
  korder = 1, nfold = 10, nsol = 100, dist_gamma = c(3.5, 3.5),
  error_measure = "deviance"
)
rtestim_tuned_mod_nb3 <- cv_mod_nb3$full_fit$Rt[, which.min(cv_mod_nb3$cv_scores)]
cv_mod_nb4 <- cv_estimate_rt(
  nb_incidence4,
  korder = 3, nfold = 10, nsol = 50, dist_gamma = c(3.5, 3.5),
  error_measure = "deviance"
)
rtestim_tuned_mod_nb4 <- cv_mod_nb4$full_fit$Rt[, which.min(cv_mod_nb4$cv_scores)]
## EpiEstim (weekly window)
mod_epi_nb_week1 <- EpiEstim::estimate_R(
  incid = nb_incidence1, config = config_week1, method = method
)
mod_epi_nb_week2 <- EpiEstim::estimate_R(
  incid = nb_incidence2, config = config_week2, method = method
)
mod_epi_nb_week3 <- EpiEstim::estimate_R(
  incid = nb_incidence3, config = config_week3, method = method
)
mod_epi_nb_week4 <- EpiEstim::estimate_R(
  incid = nb_incidence4, config = config_week4, method = method
)
## EpiEstim (monthly window)
mod_epi_nb_month1 <- EpiEstim::estimate_R(
  incid = nb_incidence1, config = config_month1, method = method
)
mod_epi_nb_month2 <- EpiEstim::estimate_R(
  incid = nb_incidence2, config = config_month2, method = method
)
mod_epi_nb_month3 <- EpiEstim::estimate_R(
  incid = nb_incidence3, config = config_month3, method = method
)
mod_epi_nb_month4 <- EpiEstim::estimate_R(
  incid = nb_incidence4, config = config_month4, method = method
)
## EpiLPS
mod_epilst_nb1 <- estimR(incidence = nb_incidence1, si = prob_gamma1)
mod_epilst_nb2 <- estimR(incidence = nb_incidence2, si = prob_gamma2)
mod_epilst_nb3 <- estimR(incidence = nb_incidence3, si = prob_gamma3)
mod_epilst_nb4 <- estimR(incidence = nb_incidence4, si = prob_gamma4)

res_dat <- data.table(res_dat,
  NB_Epi_week1 = c(rep(NA, 7), mod_epi_nb_week1$R$`Mean(R)`),
  NB_Epi_week2 = c(rep(NA, 7), mod_epi_nb_week2$R$`Mean(R)`),
  NB_Epi_week3 = c(rep(NA, 7), mod_epi_nb_week3$R$`Mean(R)`),
  NB_Epi_week4 = c(rep(NA, 7), mod_epi_nb_week4$R$`Mean(R)`),
  NB_Epi_month1 = c(rep(NA, 30), mod_epi_nb_month1$R$`Mean(R)`),
  NB_Epi_month2 = c(rep(NA, 30), mod_epi_nb_month2$R$`Mean(R)`),
  NB_Epi_month3 = c(rep(NA, 30), mod_epi_nb_month3$R$`Mean(R)`),
  NB_Epi_month4 = c(rep(NA, 30), mod_epi_nb_month4$R$`Mean(R)`),
  NB_Rtestim1 = rtestim_tuned_mod_nb1,
  NB_Rtestim2 = rtestim_tuned_mod_nb2,
  NB_Rtestim22 = rtestim_tuned_mod_nb22,
  NB_Rtestim3 = rtestim_tuned_mod_nb3,
  NB_Rtestim4 = rtestim_tuned_mod_nb4,
  NB_EpiLPS1 = c(rep(NA, 7), mod_epilst_nb1$RLPS$R[-1:-7]),
  NB_EpiLPS2 = c(rep(NA, 7), mod_epilst_nb2$RLPS$R[-1:-7]),
  NB_EpiLPS3 = c(rep(NA, 7), mod_epilst_nb3$RLPS$R[-1:-7]),
  NB_EpiLPS4 = c(rep(NA, 7), mod_epilst_nb4$RLPS$R[-1:-7])
)

fig21 <- res_dat %>%
  select(time, Rt1, NB_Epi_week1, NB_Rtestim1, NB_Rtestim2, NB_Rtestim22, NB_EpiLPS1) %>%
  mutate(NB_Rtestim2 = NB_Rtestim2 * 1e4L, NB_Rtestim22 = NB_Rtestim22 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "EpiEstim" = "NB_Epi_week1",
    "EpiLPS" = "NB_EpiLPS1",
    "True Rt" = "Rt1",
    "RtEstim (k=0)" = "NB_Rtestim1",
    "RtEstim (k=3)" = "NB_Rtestim2",
    "RtEstim (k=1)" = "NB_Rtestim22",
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 6)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 1: piecewise constant") +
  theme_bw()

fig22 <- res_dat %>%
  select(time, Rt2, NB_Epi_week2, NB_Rtestim2, NB_Rtestim22, NB_Rtestim1, NB_EpiLPS2) %>%
  mutate(NB_Rtestim1 = NB_Rtestim1 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "EpiEstim" = "NB_Epi_week2",
    "RtEstim (k=3)" = "NB_Rtestim2",
    "RtEstim (k=1)" = "NB_Rtestim22",
    "RtEstim (k=0)" = "NB_Rtestim1",
    "EpiLPS" = "NB_EpiLPS2",
    "True Rt" = "Rt2"
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 4)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 2: piecewise exponential") +
  theme_bw()

fig23 <- res_dat %>%
  select(time, Rt3, NB_Epi_week3, NB_Rtestim3, NB_Rtestim2, NB_Rtestim1, NB_EpiLPS3) %>%
  mutate(NB_Rtestim1 = NB_Rtestim1 * 1e4L, NB_Rtestim2 = NB_Rtestim2 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "EpiEstim" = "NB_Epi_week3",
    "RtEstim (k=1)" = "NB_Rtestim3",
    "RtEstim (k=0)" = "NB_Rtestim1",
    "RtEstim (k=3)" = "NB_Rtestim2",
    "EpiLPS" = "NB_EpiLPS3",
    "True Rt" = "Rt3"
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 3: piecewise linear") +
  theme_bw()

fig24 <- res_dat %>%
  select(time, Rt4, NB_Epi_week4, NB_Rtestim4, NB_Rtestim3, NB_Rtestim1, NB_EpiLPS4) %>%
  mutate(NB_Rtestim1 = NB_Rtestim1 * 1e4L, NB_Rtestim3 = NB_Rtestim3 * 1e4L) %>%
  pivot_longer(!time, names_to = "Rt_type", values_to = "Rt_value") %>%
  mutate(Rt_type = fct_recode(Rt_type,
    "EpiEstim" = "NB_Epi_week4",
    "RtEstim (k=3)" = "NB_Rtestim4",
    "RtEstim (k=0)" = "NB_Rtestim1",
    "RtEstim (k=1)" = "NB_Rtestim3",
    "EpiLPS" = "NB_EpiLPS4",
    "True Rt" = "Rt4"
  )) %>%
  mutate(Rt_type = fct_relevel(
    Rt_type, "True Rt",
    "EpiEstim",
    "EpiLPS",
    "RtEstim (k=0)",
    "RtEstim (k=1)",
    "RtEstim (k=3)"
  )) %>%
  group_by(Rt_type) %>%
  ggplot(aes(x = time, y = Rt_value, col = Rt_type)) +
  geom_line(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 8)) +
  scale_colour_manual(values = cbPalette2) +
  labs(y = "", color = "Rt methods", x = "", title = "Scenario 4: periodic") +
  theme_bw()

fig_NB_res <- ggpubr::ggarrange(fig21, fig22, fig23, fig24,
  ncol = 2, nrow = 2,
  common.legend = TRUE, legend = "bottom",
  font.label = list(size = 14)
)
fig_NB_res <- ggpubr::annotate_figure(
  fig_NB_res,
  left = grid::textGrob("Rt estimates for negative Binomial incidence",
    rot = 90, vjust = 1, gp = grid::gpar(cex = 1)
  )
)
print(fig_NB_res)
```

```{r Fig6-display-covid-BC-incidence, eval=FALSE, include=FALSE}
# Get covid-19 incidence in BC
library(CanCovidData)
dat <- get_british_columbia_case_data() %>%
  rename(HA = `Health Authority`, Date = `Reported Date`, Age = `Age group`) %>%
  filter(Date >= ymd("2020-03-01"))
cases <- dat %>% count(Date, name = "Cases")
Covid_case <- cases %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Cases), col = "black") +
  labs(x = "Date", y = "Covid-19 daily confirmed case counts in BC") +
  scale_x_date(date_breaks = "6 month") +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.title = element_text(hjust = 0.5),
    panel.spacing = unit(0.8, "lines"),
    text = element_text(size = 12)
  )
print(Covid_case)
```

```{r Fig7-display-covid-BC-Rt-est, eval=FALSE, include=FALSE}
## estimate Rt using RtEstim
# k=1
mod_rt_covid <- estimate_rt(
  x = cases$Date, cases$Cases, korder = 1, nsol = 50,
  maxiter = 1e7L
)
covid_fig1 <- plot(mod_rt_covid) +
  labs(y = "Piecewise linear Rt", x = "Date") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y-%m-%d")
cv_mod_covid <- cv_estimate_rt(
  x = cases$Date, cases$Cases, korder = 1, nfold = 10,
  maxiter = 1e7L, nsol = 50
)
mod_rtestim_covid <- cv_mod_covid$full_fit$Rt[, which.min(cv_mod_covid$cv_scores)]
rt_ci_covid <- confband(cv_mod_covid, "lambda.min") # get 95% confidence band
covid_fig_cv1 <- rt_ci_covid %>%
  ggplot(aes(x = cases$Date)) +
  geom_line(aes(y = Rt)) +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`),
    fill = "gray", alpha = 0.5
  ) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y-%m-%d") +
  labs(x = "Date", y = "") +
  theme_bw()

# k=2
mod_rt_covid <- estimate_rt(
  x = cases$Date, cases$Cases, korder = 2, nsol = 50,
  maxiter = 1e7L
)
covid_fig2 <- plot(mod_rt_covid) +
  labs(y = "Piecewise quadratic Rt", x = "Date") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y-%m-%d")
cv_mod_covid <- cv_estimate_rt(
  x = cases$Date, cases$Cases, korder = 2, nfold = 10,
  maxiter = 1e7L, nsol = 50
)
mod_rtestim_covid <- cv_mod_covid$full_fit$Rt[, which.min(cv_mod_covid$cv_scores)]
rt_ci_covid <- confband(cv_mod_covid, "lambda.min") # get 95% confidence band
covid_fig_cv2 <- rt_ci_covid %>%
  ggplot(aes(x = cases$Date)) +
  geom_line(aes(y = Rt)) +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`),
    fill = "gray", alpha = 0.5
  ) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y-%m-%d") +
  labs(x = "Date", y = "") +
  theme_bw()

# k=3
mod_rt_covid <- estimate_rt(
  x = cases$Date, cases$Cases, korder = 3, nsol = 50,
  maxiter = 1e7L
)
covid_fig3 <- plot(mod_rt_covid) +
  labs(y = "Piecewise cubic Rt", x = "Date") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y-%m-%d")
cv_mod_covid <- cv_estimate_rt(
  x = cases$Date, cases$Cases, korder = 3, nfold = 10,
  maxiter = 1e7L, nsol = 50
)
mod_rtestim_covid <- cv_mod_covid$full_fit$Rt[, which.min(cv_mod_covid$cv_scores)]
rt_ci_covid <- confband(cv_mod_covid, "lambda.min") # get 95% confidence band
covid_fig_cv3 <- rt_ci_covid %>%
  ggplot(aes(x = cases$Date)) +
  geom_line(aes(y = Rt)) +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`),
    fill = "gray", alpha = 0.5
  ) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y-%m-%d") +
  labs(x = "Date", y = "") +
  theme_bw()

Covid_BC_Rt <- ggarrange(
  covid_fig1, covid_fig_cv1, covid_fig2, covid_fig_cv2, covid_fig3, covid_fig_cv3,
  ncol = 2, nrow = 3, common.legend = TRUE, legend = "bottom"
)
print(Covid_BC_Rt)
```

```{r Fig8-display-influenza1918-data, eval=FALSE, include=FALSE}
# get the flu data from `EpiEstim` package
data("Flu1918")
n <- length(Flu1918$incidence)
flu_dat <- data.frame(Flu_incidence = Flu1918$incidence, Time = 1:n)
Flu_case <- flu_dat %>%
  ggplot(aes(y = Flu_incidence, x = Time)) +
  geom_line() +
  labs(x = "Day", y = "1918 Influenza daily incidencs in ") +
  theme_bw()
print(Flu_case)
```

```{r Fig9-display-influenza1918-Rt-est, eval=FALSE, include=FALSE}
mod_rt <- estimate_rt(Flu1918$incidence, korder = 3, nsol = 50)
fig_flu3 <- plot(mod_rt) + labs(y = "Piecewise cubic Rt", x = "Day")
cv_mod_flu <- cv_estimate_rt(Flu1918$incidence, korder = 3, nfold = 10, nsol = 50)
rt_ci_flu <- confband(cv_mod_flu, "lambda.1se") # get 95% confidence band
fig_flu_cv3 <- rt_ci_flu %>%
  ggplot(aes(x = 1:n, y = Rt)) +
  geom_line() +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), fill = "gray", alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(x = "Day", y = "") +
  theme_bw()

# k=2
mod_rt <- estimate_rt(Flu1918$incidence, korder = 2, nsol = 50)
fig_flu2 <- plot(mod_rt) + labs(y = "Piecewise quadratic Rt", x = "Day")
cv_mod_flu <- cv_estimate_rt(Flu1918$incidence, korder = 2, nfold = 10, nsol = 50)
rt_ci_flu <- confband(cv_mod_flu, "lambda.1se") # get 95% confidence band
fig_flu_cv2 <- rt_ci_flu %>%
  ggplot(aes(x = 1:n, y = Rt)) +
  geom_line() +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), fill = "gray", alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(x = "Day", y = "") +
  theme_bw()

mod_rt <- estimate_rt(Flu1918$incidence, korder = 1, nsol = 50)
fig_flu1 <- plot(mod_rt) + labs(y = "Piecewise linear Rt", x = "Day")
cv_mod_flu <- cv_estimate_rt(Flu1918$incidence, korder = 1, nfold = 10, nsol = 50)
rt_ci_flu <- confband(cv_mod_flu, "lambda.1se") # get 95% confidence band
fig_flu_cv1 <- rt_ci_flu %>%
  ggplot(aes(x = 1:n, y = Rt)) +
  geom_line() +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), fill = "gray", alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(x = "Day", y = "") +
  theme_bw()

Flu_Rt <- ggarrange(
  fig_flu1, fig_flu_cv1, fig_flu2, fig_flu_cv2, fig_flu3, fig_flu_cv3,
  ncol = 2, nrow = 3, common.legend = TRUE, legend = "bottom"
)
print(Flu_Rt)
```
