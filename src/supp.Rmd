---
title: "Supplementary details on experiments of effective reproduction number estimation with trend filtering"
author: "Jiaping Liu, Zhenglun Cai, Paul Gustafson, and Daniel J. McDonald"
date: ""
output: 
  pdf_document:
    includes:
      in_header: 
        - "header.tex"
        - "defs.tex"
    number_sections: true
    fig_caption: true
header-includes:
  - \usepackage{caption}
  - \captionsetup[figure]{labelformat=empty}
  - \def\meas{\texttt{measles}}
  - \def\sars{\texttt{SARS}}
  - \def\flu{\texttt{flu}}
  - \def\meass{\texttt{measles\_ss}}
  - \def\flus{\texttt{flu\_ss}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rtestim)
library(EpiEstim)
library(EpiLPS)
library(data.table)
library(tidyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(forcats)
library(lubridate)
library(ggpubr)
library(kableExtra)
scientific_10 <- function(x) {
  parse(text = gsub("e\\+*", " %*% 10^", scales::scientific_format()(x)))
}
source(here::here("src/exp/generate_data.R"))
source(here::here("src/exp/design_algos.R"))
source(here::here("src/exp_cluster/epiFilter.R"))
source(here::here("src/exp_cluster/epiSmoother.R"))
rt_exp_cluster611 = batchtools::loadRegistry(here::here("src/exp_cluster/rt_exp_cluster611"), writeable = T)
```

# Supplmentary details on experimental settings

We compare the accuracy of effective reproduction number estimation using Kullback divergence averaged per coordinate across EpiEstim with weekly and monthly sliding windows, EpiLPS, EpiFilter, EpiNow2, and our RtEstim with k=0,1,2,3. We consider two length of epidemics, $n=50, 300$. Since EpiNow2 runs too long (specifically, for one epidemic with n=300, it takes ???TBA), we exclude it from the comparison for long epidemics. 

We consider serial interval (SI) distributions of measles and SARS to generate long synthetic epidemics, and flu for short epidemics. Incident cases in synthetic measles epidemics are relatively low (within $1000$ at the peak overall), and incidence in SARS is relatively large (between $15000$ and $20000$ at the peak overall). 
We specifically consider a reasonably large overdispersion level of negative Binomial incidence is of size 5. 
Figure \@ref(fig:NB-overdispersion) displays the signal to noise ratio (SNR) across different settings, and compared to the counterpart of Poisson incidence (roughly fluctuating in $[1,25]$ for measles and $[1,140]$ for SARS), the negative Binomial incidence appears to have an apparently smaller SNR (roughly in $[1,2.5]$ for both epidemics).

```{r NB-overdispersion, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "Dispersion/Overdispersion level of incidence"}
dat_example <- readRDS(here::here("dat/data_example.RDS"))
size <- 5
dat_example_NB_SMR <- dat_example %>%
  filter(dist == "Negative Binomial") %>%
  group_by(Rt_case, si_type) %>%
  mutate(smr = sqrt(mean + mean^2 / size) / mean)
dat_example_pois_SMR <- dat_example %>%
  filter(dist == "Poisson") %>%
  group_by(Rt_case, si_type) %>%
  mutate(smr = sqrt(mean) / mean)
dat_example_SMR <- rbind(dat_example_pois_SMR, dat_example_NB_SMR)

# plot the SNR (mean/sd) ratio
fig_smr <- dat_example_SMR %>%
  group_by(dist, Rt_case, si_type) %>%
  ggplot(aes(y = smr, x = time)) + 
  geom_line(aes(color = si_type)) + 
  facet_grid(dist ~ Rt_case) + #, scales = "free"
  scale_color_brewer(palette = "Set1") +
  labs(y = "Sigma to mean ratio", x = "Time") + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(title = NULL))
print(fig_smr)
```

In model fitting, we consider to use both true and misspecified serial interval (SI) distributions. The misspecification of serial interval distributions are either mild or major, where, in the major misspecification, we use SI of SARS to solve long measles epidemics and SI of measles to solve short flu epidemics. While, in the mild SI misspecification, we consider a shaped (mean increased by 2) and scaled (standard deviation increased by $10%$) parameters of SI distributions for both short flu and long measles epidemics, denoted as \flus and \meass respectively. 
It results in seven pairs of SI distributions for incidence generating and model fitting, 
i.e., (\meas, \meas), (\sars, \sars), (\meas, \meass), (\meas, \sars) for long epidemics 
and (\flu, \flu), (\flu, \flus), (\flu, \meas) for short epidemics. 
Figure \@ref(fig:si-dist) displays the SI distributions of \meas, \meass, \sars, \flu, and \flus. 

```{r si-dist, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "SI curves"}
dat_si <- data.table(
  x = 0:40,
  Measles = dgamma(0:40L, shape = 14.5963, scale = 1.0208),
  SARS = dgamma(0:40L, shape = 4.8864, scale = 1.7190),
  Flu = dgamma(0:40L, shape = 3.0044, scale = 0.8654),
  measles_ss = dgamma(0:40L, shape = 15.5188, scale = 1.0890),
  flu_ss = dgamma(0:40L, shape = 7.7723, scale = 0.5918)
)

dat_si %>%
  pivot_longer(!x, values_to = "prob", names_to = "epidemic") %>%
  mutate(epidemic = fct_recode(epidemic,
    "Shaped and scaled flu" = "flu_ss",
    "Shaped and scaled measles" = "measles_ss"
  )) %>%
  group_by(epidemic) %>%
  ggplot(aes(x = x, y = prob)) + 
  geom_line(aes(col = epidemic)) + 
  geom_ribbon(aes(ymin = 0, ymax = prob, fill = epidemic), alpha = 0.3) +
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  labs(y = "Probability", x = "Index") + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw() + 
  theme(legend.position = "bottom") +
  guides(color = guide_legend(title = NULL), fill = "none")
```


For long epidemics with $300$ timepoints, we consider 4 SI pairs applied on 2 incidence distributions using 4 $\calR_t$ scenarios solved by 8 methods including EpiEstim with weekly and monthly sliding windows, EpiLPS, EpiFilter, and RtEstim with k=0,1,2,3, which results in 256 experimental settings in total. Each experimental setting is replicated for 50 times, which gives $12800$ experiments. 
For short epidemics with $50$ timepoints, we consider 3 SI pairs with 2 incidence distributions and 1 $\calR_t$ scenario, solved by 9 methods including the methods for long epidemics and EpiNow2, which results in 54 experimental settings. With 50 replicates, there are $2700$ experiments.

<!-- 
The following table gives a summary of the experimental settings. 

```{r exp-setting-table-long, echo=FALSE, tab.cap="Summary of experimental settings"}
jobs_long <- findExperiments(prob.name = "prob_design", algo.name = "algo_design")
jobs_long2 <- findExperiments(prob.name = "prob_design_si", algo.name = "algo_design_si")
tbl_long <- summarizeExperiments(rbind(jobs_long, jobs_long2), by = c("Rt_case", "dist", "si_type", "si_pars"))
tbl_long <- data.table(Length = 300, tbl_long)

jobs_short <- findExperiments(prob.name = "prob_design_short", algo.name = "algo_design_all")
jobs_short2 <- findExperiments(prob.name = "prob_design_si_short", algo.name = "algo_design_si_short")
tbl_short <- summarizeExperiments(rbind(jobs_short, jobs_short2), by = c("Rt_case", "dist", "si_type", "si_pars"))
tbl_short <- data.table(Length = 50, tbl_short)

colname <- c("Length", "Rt Scenario", "Incidence distribution", 
             "SI for epidemics", "SI for modelling", "# experiments") 
kable(rbind(tbl_long, tbl_short), col.names = colname, escape = F) %>%
  kable_styling(latex_options = "hold_position") %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  footnote(alphabet = c("measles_ss represents shaped and scaled measles parameters.", 
                        "flu_ss represents shaped and scaled flu parameters."))
```

-->

Here we list the hyperparameters used in modelling for each method. Most of them are 
the experimental settings used in the papers where they were proposed and deemed as 
the ``best" tuned ones. 
We consider both weekly and monthly sliding windows in EpiEstim, 
40 basis functions in EpiLPS with the NelderMead method to maximize the
hyperparameter posterior distribution. 
We input 2000 grid size in EpiFilter with 0.1 diffusion noise and uniform prior on Rt with mean 1/2000, and use the smoothed Rt as estimates. 
We run 10-fold cross validation (CV) to choose the best tuning parameter
from the candidate set of size $50$, i.e., $\boldsymbol{\lambda} = \{\lambda_1,
\cdots, \lambda_{50}\}$. Specifically, we divide all samples (except the 
first and last entries) into ten folds evenly and randomly, and build models on 
each sample set by leaving a fold out across all hyperparameters. We select the 
tuning parameter that gives the lowest averaged ***deviance*** between the 
estimated incidence and the observed samples averaged over all folds. 

We have visualized the main results of accuracy (using KL excluding the first week) for long epidemics under all settings across all methods in the section of results for synthetic data. We will visualize other main experimental results in the following. 

# Supplementary experimental results on long epidemics for Section 3.1

Fig 10 displays the KL divergence values for negative Binomial incidence. 
Comparing across $\calR_t$ estimates by EpiLPS, RtEstim and
EpiEstim with ***monthly*** sliding windows, KL divergence computation
excludes the first month of $\calR_t$ estimates for all approaches, since 
EpiEstim estimates with the monthly sliding windows are not available until
the second month. The $y$-axis is displayed on a logarithmic scale for a 
better visualization, since a few values are much larger than others. 

The relative performance of EpiEstim with monthly sliding windows, in general, 
is not as good as its weekly sliding window based on the relative positions of 
its boxes and the counterparts of the other methods, except for the Scenario 2 
with negative Binomial incidence. It can be explained by EpiEstim with longer 
sliding windows assume similarity of neighbouring $\calR_t$ across longer 
periods, and thus, is smoother and less accurate compared to the one with 
shorter sliding windows. 

```{r load-simulation-results, include=FALSE}
cbPalette <- c(
  "#E69F00", "#F0E442", "#009E73", "#FDBE85", "#D55E00", 
  "#CC79A7", "#0072B2", "#b44582", "#56B4E9"
)
Rt_result <- readRDS(here::here("dat/rt_cluster_results611.RDS"))
Rt_result <- Rt_result %>%
  select(method, Rt_case, dist, runtime, Rt_kl, Rt_kl_month, si_type, si_pars, len) %>%
  mutate(method = fct_recode(method,
    "EpiEstim (weekly)" = "EpiEstim(week)",
    "EpiEstim (monthly)" = "EpiEstim(month)",
    "RtEstim (k=0)" = "RtEstim(k=0)",
    "RtEstim (k=1)" = "RtEstim(k=1)",
    "RtEstim (k=2)" = "RtEstim(k=2)",
    "RtEstim (k=3)" = "RtEstim(k=3)"
  )) %>%
  mutate(method = fct_relevel(
    method, 
    "EpiEstim (weekly)", "EpiEstim (monthly)", "EpiLPS",
    "EpiFilter", "EpiNow2",
    "RtEstim (k=0)", "RtEstim (k=1)",
    "RtEstim (k=2)", "RtEstim (k=3)"
  )) %>%
  mutate(dist = fct_recode(dist,
    "Poisson" = "poisson",
    "Negative Binomial" = "NB"
  )) %>%
  mutate(dist = fct_relevel(dist, "Poisson", "Negative Binomial")) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  )) #%>%
  #mutate(Rt_kl = Rt_kl * n, Rt_kl_month = Rt_kl_month * n) # sum up KL per coordinate
```


```{r display-KL-monthly-measles, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first months for measles epidemics. Y-axis is on a logarithmic scale."}
Rt_res_long_month_no_outliers <- Rt_result %>% 
  filter(len == 300, !method %in% c("EpiEstim (weekly)", "EpiNow2")) %>% 
  select(Rt_case, dist, method, Rt_kl_month, si_type, si_pars) %>% 
  group_by(Rt_case, dist, method) %>% 
  mutate(big_out = Rt_kl_month > fivenum(Rt_kl_month, na.rm = TRUE)[4] +
    1.5 * IQR(Rt_kl_month, na.rm = TRUE)) %>% 
  filter(!big_out) %>% 
  select(!big_out)

fig_kl_month_measles <- Rt_res_long_month_no_outliers %>%
  filter(si_type == "measles", si_pars == "measles") |> # SARS, measles?
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl_month)) + 
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[c(2:4,6:9)]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_month_measles)
```

```{r display-KL-monthly-sars, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first months for SARS epidemics. Y-axis is on a logarithmic scale."}
fig_kl_month_sars <- Rt_res_long_month_no_outliers %>%
  filter(si_type == "SARS", si_pars == "SARS") |> # SARS, measles?
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl_month)) + # averaged over KL per coordinate
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[c(2:4,6:9)]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_month_sars)
```

# Experimental results on short epidemics

```{r display-KL-weekly-flu, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first weeks for flu epidemics. Y-axis is on a logarithmic scale."}
Rt_res_short_week_no_outliers <- Rt_result %>% 
  filter(len == 50, !method %in% c("EpiEstim (monthly)", "EpiNow2")) %>% 
  select(Rt_case, dist, method, Rt_kl, si_type, si_pars) %>% 
  group_by(Rt_case, dist, method) %>% 
  mutate(big_out = Rt_kl > fivenum(Rt_kl, na.rm = TRUE)[4] +
    1.5 * IQR(Rt_kl, na.rm = TRUE)) %>% 
  filter(!big_out) %>% 
  select(!big_out)

fig_kl_short_week <- Rt_res_short_week_no_outliers %>%
  filter(si_type == "flu", si_pars == "flu") |> # si_pars == flu or measles
  select(Rt_case, dist, method, Rt_kl) |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl)) + # averaged over KL per coordinate
  stat_boxplot(aes(col = method)) +
  facet_grid(~dist, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[-2]) +
  labs(x = "Method", y = "KL divergence (excluding first week) for short epidemics") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_short_week)
```

```{r display-KL-monthly-flu, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first months for flu epidemics. Y-axis is on a logarithmic scale."}
Rt_res_short_month_no_outliers <- Rt_result %>% 
  filter(len == 50, method != "EpiEstim (weekly)") %>% 
  select(Rt_case, dist, method, Rt_kl_month, si_type, si_pars) %>% 
  group_by(Rt_case, dist, method) %>% 
  mutate(big_out = Rt_kl_month > fivenum(Rt_kl_month, na.rm = TRUE)[4] +
    1.5 * IQR(Rt_kl_month, na.rm = TRUE)) %>% 
  filter(!big_out) %>% 
  select(!big_out)

fig_kl_short_month <- Rt_res_short_month_no_outliers %>%
  filter(si_type == "flu", si_pars == "flu") |> # si_pars == flu or measles
  select(Rt_case, dist, method, Rt_kl_month) |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl_month)) + # averaged over KL per coordinate
  stat_boxplot(aes(col = method)) +
  facet_grid(~dist, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[-1]) +
  labs(x = "Method", y = "KL divergence (excluding first month) for short epidemics") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_short_month)
```

<!-- 
# Supplementary results of experiments for Fig 3 in Section 3.2 
The full KL divergence values for Poisson incidence without excluding the 
outliers are shown in Fig 11. The $y$-axis is displayed on a logarithmic scale 
for the same reason in Fig 10.

Comparing among $\calR_t$ estimations by EpiLPS, RtEstim and EpiEstim with
***weekly*** sliding windows, KL divergence computation excludes the first week
of $\calR_t$ estimates for all approaches. The outliers are mainly EpiLPS and 
EpiEstim $\calR_t$ estimations in Scenario 2, which is generally an easy problem 
except for the changepoint at where the two segments are discontinuous. Since 
EpiEstim produces a continuous $\calR_t$ curve, the changepoint can be difficult 
to recover and make estimation less accurate.

```{r display-KL-weekly-full-res, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "Fig 11. KL divergence for methods with weekly sliding windows. Y-axis is on a logarithmic scale."}
fig_kl_full_week <- Rt_result %>%
  filter(method != "EpiEstim (monthly)") |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl)) + # sum up KL per coordinate
  geom_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[-2]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_full_week)
```
-->

# Misspecification of serial interval function parameters

## Mild misspecification 

For long epidemics, ...

```{r display-KL-weekly-measles-measle_ss, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first weeks for measle epidemics with mild SI misspecification. Y-axis is on a logarithmic scale."}
Rt_res_long_week_no_outliers <- Rt_result %>% 
  filter(len == 300, method != "EpiEstim (monthly)") %>% 
  select(Rt_case, dist, method, Rt_kl, si_type, si_pars) %>% 
  group_by(Rt_case, dist, method) %>% 
  mutate(big_out = Rt_kl > fivenum(Rt_kl, na.rm = TRUE)[4] +
    1.5 * IQR(Rt_kl, na.rm = TRUE)) %>% 
  filter(!big_out) %>% 
  select(!big_out)

#fig_kl_full_week_si2 <- Rt_res_long_week_no_outliers %>%
#  filter(si_type == "measles", si_pars == "measles_ss") |> 
#  select(Rt_case, dist, method, Rt_kl) |>
#  group_by(Rt_case, dist, method) |>
#  ggplot(aes(x = method, y = Rt_kl)) + 
#  stat_boxplot(aes(col = method)) +
#  facet_grid(dist ~ Rt_case, scales = "free") +
#  scale_y_log10() +
#  scale_colour_manual(values = cbPalette[c(1,3,4,6:9)]) +
#  labs(x = "Method", y = "KL divergence") +
#  theme_bw() +
#  theme(axis.text.x = element_blank(), legend.position = "bottom") +
#  guides(color = guide_legend(title = NULL, byrow=TRUE))
#print(fig_kl_full_week_si2)

```

```{r display-KL-monthly-measles-measle_ss, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first months for measle epidemics with mild SI misspecification. Y-axis is on a logarithmic scale."}
Rt_res_long_month_no_outliers <- Rt_result %>% 
  filter(len == 300, method != "EpiEstim (weekly)") %>% 
  select(Rt_case, dist, method, Rt_kl_month, si_type, si_pars) %>% 
  group_by(Rt_case, dist, method) %>% 
  mutate(big_out = Rt_kl_month > fivenum(Rt_kl_month, na.rm = TRUE)[4] +
    1.5 * IQR(Rt_kl_month, na.rm = TRUE)) %>% 
  filter(!big_out) %>% 
  select(!big_out)

#fig_kl_full_month_si2 <- Rt_res_long_month_no_outliers %>%
#  filter(method != "EpiEstim (weekly)") |>
#  filter(si_type == "measles", si_pars == "measles_ss") |> 
#  select(Rt_case, dist, method, Rt_kl_month) |>
#  group_by(Rt_case, dist, method) |>
#  ggplot(aes(x = method, y = Rt_kl_month)) + 
#  stat_boxplot(aes(col = method)) +
#  facet_grid(dist ~ Rt_case, scales = "free") +
#  scale_y_log10() +
#  scale_colour_manual(values = cbPalette[c(2:4,6:9)]) +
#  labs(x = "Method", y = "KL divergence") +
#  theme_bw() +
#  theme(axis.text.x = element_blank(), legend.position = "bottom") +
#  guides(color = guide_legend(title = NULL, byrow=TRUE))
#print(fig_kl_full_month_si2)
```

For short epidemics, 

```{r display-KL-weekly-flu-flu_ss, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first weeks for flu epidemics with mild SI misspecification. Y-axis is on a logarithmic scale."}
#fig_kl_short_week_si2 <- Rt_res_short_week_no_outliers %>%
#  filter(method != "EpiEstim (monthly)") |>
#  filter(si_type == "flu", si_pars == "flu_ss") |> # si_pars == flu or measles
#  select(Rt_case, dist, method, Rt_kl) |>
#  group_by(Rt_case, dist, method) |>
#  ggplot(aes(x = method, y = Rt_kl)) + # averaged over KL per coordinate
#  stat_boxplot(aes(col = method)) +
#  facet_grid(dist ~ Rt_case, scales = "free") +
#  scale_y_log10() +
#  scale_colour_manual(values = cbPalette[-2]) +
#  labs(x = "Method", y = "KL divergence (excluding first week) for short epidemics") +
#  theme_bw() +
#  theme(axis.text.x = element_blank(), legend.position = "bottom") +
#  guides(color = guide_legend(title = NULL, byrow=TRUE))
#print(fig_kl_short_week_si2)

```

```{r display-KL-monthly-flu-flu_ss, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first weeks for flu epidemics with mild SI misspecification. Y-axis is on a logarithmic scale."}
#fig_kl_short_month_si2 <- Rt_res_short_month_no_outliers %>%
#  filter(method != "EpiEstim (weekly)") |>
#  filter(si_type == "flu", si_pars == "flu_ss") |> # si_pars == flu or measles
#  select(Rt_case, dist, method, Rt_kl_month) |>
#  group_by(Rt_case, dist, method) |>
#  ggplot(aes(x = method, y = Rt_kl_month)) + # averaged over KL per coordinate
#  stat_boxplot(aes(col = method)) +
#  facet_grid(dist ~ Rt_case, scales = "free") +
#  scale_y_log10() +
#  scale_colour_manual(values = cbPalette[-1]) +
#  labs(x = "Method", y = "KL divergence (excluding first month) for short epidemics") +
#  theme_bw() +
#  theme(axis.text.x = element_blank(), legend.position = "bottom") +
#  guides(color = guide_legend(title = NULL, byrow=TRUE))
#print(fig_kl_short_month_si2)
```

## Major misspecification 

```{r display-KL-weekly-measles-sars, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first weeks for measle epidemics with major SI misspecification. Y-axis is on a logarithmic scale."}
fig_kl_full_week_si <- Rt_res_long_week_no_outliers %>%
  filter(si_type == "measles", si_pars == "SARS") |> 
  select(Rt_case, dist, method, Rt_kl) |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl)) + 
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[c(1,3,4,6:9)]) +
  labs(x = "Method", y = "KL divergence (excluding first week)") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_full_week_si)
```

```{r display-KL-monthly-measles-sars, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first months for measle epidemics with major SI misspecification. Y-axis is on a logarithmic scale."}
fig_kl_full_month_si <- Rt_res_long_month_no_outliers %>%
  filter(method != "EpiEstim (weekly)") |>
  filter(si_type == "measles", si_pars == "SARS") |> 
  select(Rt_case, dist, method, Rt_kl_month) |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl_month)) + 
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[c(2:4,6:9)]) +
  labs(x = "Method", y = "KL divergence (excluding first month)") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_full_month_si)
```

```{r display-KL-weekly-flu-measles, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first weeks for flu epidemics with major SI misspecification. Y-axis is on a logarithmic scale."}
fig_kl_short_week_si <- Rt_res_short_week_no_outliers %>%
  filter(method != "EpiEstim (monthly)") |>
  filter(si_type == "flu", si_pars == "measles") |> # si_pars == flu or measles
  select(Rt_case, dist, method, Rt_kl) |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl)) + # averaged over KL per coordinate
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[-2]) +
  labs(x = "Method", y = "KL divergence (excluding first week) for short epidemics") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_short_week_si)
```

```{r display-KL-monthly-flu-measles, echo=FALSE, fig.height=5.5, fig.width=6.2, fig.cap = "KL divergence excluding the first months for flu epidemics with major SI misspecification. Y-axis is on a logarithmic scale."}
fig_kl_short_month_si <- Rt_res_short_month_no_outliers %>%
  filter(method != "EpiEstim (weekly)") |>
  filter(si_type == "flu", si_pars == "measles") |> # si_pars == flu or measles
  select(Rt_case, dist, method, Rt_kl_month) |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl_month)) + # averaged over KL per coordinate
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[-1]) +
  labs(x = "Method", y = "KL divergence (excluding first month) for short epidemics") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_short_month_si)
```

# Confidence interval coverage

```{r ci-results, include=FALSE}
library(forcats)
CI_result <- readRDS(here::here("dat/rt_cluster_ci_results108.RDS"))
CI_result <- CI_result %>%
  mutate(method = fct_recode(
    method,
    "EpiEstim (weekly)" = "EpiEstim(week)",
    "EpiEstim (monthly)" = "EpiEstim(month)",
    "RtEstim (k=0)" = "RtEstim(k=0)",
    "RtEstim (k=1)" = "RtEstim(k=1)",
    "RtEstim (k=2)" = "RtEstim(k=2)",
    "RtEstim (k=3)" = "RtEstim(k=3)"
  )) %>%
  mutate(method = fct_relevel(
    method, 
    "EpiEstim (weekly)", 
    "EpiEstim (monthly)", 
    "EpiLPS", 
    "EpiFilter",
    "RtEstim (k=0)", 
    "RtEstim (k=1)", 
    "RtEstim (k=2)", 
    "RtEstim (k=3)"
  )) %>%
  mutate(dist = fct_recode(
    dist,
    "Poisson" = "poisson",
    "Negative Binomial" = "NB"
  )) %>%
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  ))
ci_len <- double(nrow(CI_result))
for(i in 1:nrow(CI_result)) {
  ci_len[i] <- length(CI_result[i,]$ci_coverage[[1]])
}
CI_result <- data.table(CI_result, ci_len)
```

```{r ci-coverage-measles, echo=FALSE, fig.height=5.5, fig.width=6.2, message=FALSE, warning=FALSE}
Rt_res_ci <- CI_result %>%
  select(si_type, ci_len, dist, Rt_case, method, ci_coverage) %>%
  group_by(si_type, dist, Rt_case, method) %>%
  unnest_wider(ci_coverage, names_sep = "")

# replace NAs with negative values
columns_to_replace <- paste0("ci_coverage", 1:300)
Rt_res_ci_noNAs <- Rt_res_ci %>%
  mutate_at(vars(columns_to_replace), list(~ replace_na(., -1)))
Rt_res_ci_noNAs <- Rt_res_ci_noNAs %>% 
  group_by(si_type, ci_len, dist, Rt_case, method) %>%
  summarize(across(all_of(columns_to_replace), mean)) %>%
  pivot_longer(cols = columns_to_replace, names_to = "index", values_to = "ci_coverage") %>%
  mutate(index = as.numeric(gsub("\\D", "", index))) %>%
  mutate(time_index = 300 - ci_len + index) %>%
  group_by(dist, method, Rt_case) %>%
  filter(ci_coverage >= 0) 

ci_cover_measles <- Rt_res_ci_noNAs %>% # exclude NAs for certain methods
  filter(si_type == "measles") %>% # SARS
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[-5]) + 
  labs(y = "CI coverage for measles epidemics") + 
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(ci_cover_measles)
```

```{r ci-coverage-sars, echo=FALSE, fig.height=5.5, fig.width=6.2, message=FALSE, warning=FALSE}
ci_cover_sars <- Rt_res_ci_noNAs %>% # exclude NAs for certain methods
  filter(si_type == "SARS") %>% # SARS
  ggplot(aes(y = ci_coverage, x = time_index)) +
  geom_line(aes(col = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[-5]) + 
  labs(y = "CI coverage for SARS epidemics") + 
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(ci_cover_sars)
```

```{r ci-percentage-measles, echo=FALSE, fig.height=5.5, fig.width=6.2, message=FALSE, warning=FALSE}
ci_percent_measles <- CI_result %>% 
  filter(si_type == "measles") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_percentage, x = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  geom_hline(yintercept = 0.95, color = "orange", linetype = "dashed") + 
  labs(x = "Methods", y = "CI percentages of coverage for measles epidemics") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(ci_percent_measles)
```

```{r ci-percentage-sars, echo=FALSE, fig.height=5.5, fig.width=6.2, message=FALSE, warning=FALSE}
ci_percent_sars <- CI_result %>% 
  filter(si_type == "SARS") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_percentage, x = method)) + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  geom_hline(yintercept = 0.95, color = "orange", linetype = "dashed") + 
  labs(x = "Methods", y = "CI percentages of coverage for SARS epidemics") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(ci_percent_sars)
```

```{r ci-score-measles, echo=FALSE, fig.height=5.5, fig.width=6.2, message=FALSE, warning=FALSE}
ci_score_measles <- CI_result %>% 
  filter(method != "EpiLPS") %>% # too large
  filter(si_type == "measles") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_score, x = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  scale_y_log10() +
  labs(x = "Methods", y = "Interval scores") + 
  theme_bw() + 
  labs(y = "Interval scores for measles epidemics") + 
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(ci_score_measles)
```

```{r ci-score-sars, echo=FALSE, fig.height=5.5, fig.width=6.2, message=FALSE, warning=FALSE}
ci_score_sars <- CI_result %>% 
  filter(method != "EpiLPS") %>% # too large
  filter(si_type == "SARS") %>%
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(y = ci_score, x = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  geom_boxplot(aes(col = method)) +
  scale_colour_manual(values = cbPalette) +
  scale_y_log10() +
  labs(x = "Methods", y = "Interval scores") + 
  theme_bw() + 
  labs(y = "Interval scores for SARS epidemics") + 
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(ci_score_sars)
```

# Time comparisons of methods for Section 3.2

Fig 12 shows the time comparisons across all methods. EpiEstim with both weekly 
and monthly sliding windows are very fast and converge in less than 0.1 seconds.
Piecewise constant RtEstim (with k=0) estimates can be generated within 0.1 
seconds as well. EpiLPS is slightly slower, but still very fast and within 1 
second for all experiments. Piecewise linear and cubic RtEstim (with $k=1$ and 
$k=3$ respectively) are slower, but mostly within 10 seconds. 

It is remarkable that our RtEstim computes 50 lambda values with 10-fold CV for 
each experiment, which results in $550$ times of modelling per experiment 
(including modelling for all folds). The 
running times are no more than 10 seconds for most of the experiments, which 
means the running time for each time of modelling is very fast, and on average 
can be less than 0.02 seconds. The other two methods only run once for a fixed 
set of hyperparameters for each experiment. 

```{r display-simulation-time-comparison, echo = FALSE, fig.height = 7, fig.width = 6.6, fig.cap = "Fig 12. Time comparisons of methods (excluding one outlier of `RtEstim (k=1)` in Scenario 2 with negative Binomial incidence). Y-axis is on a logarithmic scale."}
Rt_result_runtime_no_outlier <- Rt_result %>%
  select(Rt_case, dist, method, runtime, si_type, si_pars, len) %>% 
  group_by(Rt_case, dist, method) %>% 
  mutate(big_out = runtime > fivenum(runtime, na.rm = TRUE)[4] +
    1.5 * IQR(runtime, na.rm = TRUE)) %>% 
  filter(!big_out) %>% 
  select(!big_out)

runtime_epi_long <- Rt_result_runtime_no_outlier %>%
  filter(len != 50) |>
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(x = Rt_case, y = runtime / 1e6)) +
  geom_boxplot(aes(col = method)) +
  facet_wrap(vars(dist)) +
  scale_colour_manual(values = cbPalette[-5]) +
  scale_y_log10() +
  labs(y = "Running time for long epidemics in seconds", x = "Rt scenarios") +
  labs(color = "Methods") +
  theme_bw() +
  theme(legend.position = "bottom", axis.text.x = element_blank()) +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(runtime_epi_long)

runtime_epi_short <- Rt_result_runtime_no_outlier %>%
  filter(len == 50) |>
  group_by(dist, Rt_case, method) %>%
  ggplot(aes(x = method, y = runtime / 1e6)) +
  geom_boxplot(aes(col = method)) +
  facet_wrap(vars(dist)) +
  scale_colour_manual(values = cbPalette) +
  scale_y_log10() +
  labs(y = "Running time for short epidemics in seconds", x = "Methods") +
  labs(color = "Methods") +
  theme_bw() +
  theme(legend.position = "bottom", axis.text.x = element_blank()) +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(runtime_epi_short)
```


<!-- The following R chunks reproduce figures in the main manuscript. -->

```{r Fig1-display-cancovid-example, eval = FALSE, include = FALSE}
library(rtestim)
cancovid <- cancovid[-1:-65, ] # drop the beginning period
n <- nrow(cancovid)

# plot fitted Rt with confidence band
cv_mod <- cv_estimate_rt(
  x = cancovid$date, cancovid$incident_cases, korder = 2, nfold = 10,
  maxiter = 1e7L, nsol = 50, error_measure = "deviance",
  lambda_min_ratio = 1e-6, init = configure_rt_admm(tol = 1e-6)
)
rt_ci_covid <- confband(cv_mod, "lambda.1se") # get 95% confidence band
fig_rt_fit <- rt_ci_covid %>%
  ggplot(aes(x = cancovid$date)) +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), fill = "gray", alpha = 0.5) +
  geom_line(aes(y = Rt), col = "#0072B2", lwd = 1) +
  scale_x_date(date_breaks = "8 months", date_labels = "%Y-%m-%d", expand = expansion(c(0, 0.05))) +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(x = "Date", y = "Piecewise quadratic Rt with 95% CIs") +
  theme_bw()

# plot fitted incidence
mod_best <- estimate_rt(
  x = cancovid$date, cancovid$incident_cases, korder = 2, maxiter = 1e7L,
  lambda = cv_mod$lambda.1se
)
incidence_fit <- mod_best$weighted_past_counts * rt_ci_covid$Rt
inc_dat <- data.table(cancovid, incidence_fit = incidence_fit)
fig_inc_fit <- inc_dat %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = incident_cases / 1000)) +
  geom_line(aes(y = incidence_fit / 1000), col = "#D55E00", lwd = 1) +
  scale_x_date(date_breaks = "8 months", date_labels = "%Y-%m-%d", expand = expansion(c(0, 0.05))) +
  labs(x = "Date", y = "Fitted incidence (per 1,000)") +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw()

CANCovid_fig <- ggarrange(
  fig_rt_fit, fig_inc_fit,
  ncol = 1, common.legend = TRUE, legend = "bottom"
)
print(CANCovid_fig)

ggsave(here::here("fig/intro-fig-new.png"), plot = CANCovid_fig, width = 6.5, height = 6)
```

```{r Figs2-4-display-data-examples, eval = FALSE, include = FALSE}
# generate a random sample for each setting (of Rt scenario, incidence distribution, serial interval distribution)
dat1_pois_measles <- data_generator(Rt_case = 1, dist = "poisson", si_type = "measles", seed = 9)
dat2_pois_measles <- data_generator(Rt_case = 2, dist = "poisson", si_type = "measles", seed = 4)
dat3_pois_measles <- data_generator(Rt_case = 3, dist = "poisson", si_type = "measles", seed = 9)
dat4_pois_measles <- data_generator(Rt_case = 4, dist = "poisson", si_type = "measles", seed = 4)
dat1_NB_measles <- data_generator(Rt_case = 1, dist = "NB", si_type = "measles", seed = 3)
dat2_NB_measles <- data_generator(Rt_case = 2, dist = "NB", si_type = "measles", seed = 5)
dat3_NB_measles <- data_generator(Rt_case = 3, dist = "NB", si_type = "measles", seed = 6)
dat4_NB_measles <- data_generator(Rt_case = 4, dist = "NB", si_type = "measles", seed = 4)
dat1_pois_SARS <- data_generator(Rt_case = 1, dist = "poisson", si_type = "SARS", seed = 792)
dat2_pois_SARS <- data_generator(Rt_case = 2, dist = "poisson", si_type = "SARS", seed = 1)
dat3_pois_SARS <- data_generator(Rt_case = 3, dist = "poisson", si_type = "SARS", seed = 792)
dat4_pois_SARS <- data_generator(Rt_case = 4, dist = "poisson", si_type = "SARS", seed = 3)
dat1_NB_SARS <- data_generator(Rt_case = 1, dist = "NB", si_type = "SARS", seed = 86)
dat2_NB_SARS <- data_generator(Rt_case = 2, dist = "NB", si_type = "SARS", seed = 5)
dat3_NB_SARS <- data_generator(Rt_case = 3, dist = "NB", si_type = "SARS", seed = 37)
dat4_NB_SARS <- data_generator(Rt_case = 4, dist = "NB", si_type = "SARS", seed = 29)

# combine the random samples as a data table  
dat_example <- data.table(incidence = c(dat1_pois_measles$incidence, 
                                        dat2_pois_measles$incidence,
                                        dat3_pois_measles$incidence,
                                        dat4_pois_measles$incidence,
                                        dat1_NB_measles$incidence,
                                        dat2_NB_measles$incidence,
                                        dat3_NB_measles$incidence,
                                        dat4_NB_measles$incidence,
                                        dat1_pois_SARS$incidence,
                                        dat2_pois_SARS$incidence,
                                        dat3_pois_SARS$incidence,
                                        dat4_pois_SARS$incidence,
                                        dat1_NB_SARS$incidence,
                                        dat2_NB_SARS$incidence,
                                        dat3_NB_SARS$incidence,
                                        dat4_NB_SARS$incidence),
                          mean = c(dat1_pois_measles$mean, 
                                   dat2_pois_measles$mean,
                                   dat3_pois_measles$mean,
                                   dat4_pois_measles$mean,
                                   dat1_NB_measles$mean,
                                   dat2_NB_measles$mean,
                                   dat3_NB_measles$mean,
                                   dat4_NB_measles$mean,
                                   dat1_pois_SARS$mean,
                                   dat2_pois_SARS$mean,
                                   dat3_pois_SARS$mean,
                                   dat4_pois_SARS$mean,
                                   dat1_NB_SARS$mean,
                                   dat2_NB_SARS$mean,
                                   dat3_NB_SARS$mean,
                                   dat4_NB_SARS$mean),
                          trueRt = rep(c(dat1_pois_measles$Rt,
                                         dat2_pois_measles$Rt,
                                         dat3_pois_measles$Rt,
                                         dat4_pois_measles$Rt), 4),
                          time = rep(1:300, 4 * 4),
                          Rt_case = rep(rep(1:4, each = 300), 4),
                          dist = rep(rep(c("Poisson", "Negative Binomial"), each = 300 * 4), 2),
                          si_type = rep(c("measles", "SARS"), each = 4 * 300 * 2)
                          )
dat_example <- dat_example %>%
  mutate(dist = fct_relevel(
    dist, 
    "Poisson", 
    "Negative Binomial"
  )) %>%
  mutate(Rt_case = as.character(Rt_case)) %>% 
  mutate(Rt_case = fct_recode(
    Rt_case,
    "Scenario 1" = "1",
    "Scenario 2" = "2",
    "Scenario 3" = "3",
    "Scenario 4" = "4"
  ))

# save examples
saveRDS(dat_example, here::here("dat/data_example.RDS"))

# display Rt
fig_true_rt <- dat_example %>%
  mutate(Rt_case = fct_recode(Rt_case,
    "Scenario 1: piecewise constant" = "Scenario 1",
    "Scenario 2: piecewise exponential" = "Scenario 2",
    "Scenario 3: piecewise linear" = "Scenario 3",
    "Scenario 4: periodic" = "Scenario 4"
  )) %>%
  group_by(Rt_case) %>%
  ggplot(aes(y = trueRt, x = time)) +
  geom_line() +
  facet_wrap(~ Rt_case, scales = "free") + #facet_grid
  labs(y = "True Rt curves", x = "Time") +
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw()

# display each setting of the random samples
fig_measles_data <- dat_example %>%
  filter(si_type == "measles") %>%
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = time, y = incidence)) +
  geom_line() + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Incidence of measles epidemics", x = "Time") +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw()
  
fig_sars_data <- dat_example %>%
  filter(si_type == "SARS") %>%
  group_by(Rt_case, dist) %>%
  ggplot(aes(x = time, y = incidence)) +
  geom_line() + 
  facet_grid(dist ~ Rt_case, scales = "free") +
  labs(y = "Incidence of SARS epidemics", x = "Time") +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw()

# save plots
ggsave(plot=fig_true_rt, here::here("fig/fig_true_rt.png"), width = 6.5, height = 5)
ggsave(plot=fig_measles_data, here::here("fig/fig_measles_data.png"), width = 6.5, height = 5)
ggsave(plot=fig_sars_data, here::here("fig/fig_sars_data.png"), width = 6.5, height = 5)
```

```{r Figs-display-simulation-results, eval = FALSE, include = FALSE}
# exclude the extremely large KL values (excluding the first weeks)
#Rt_res_long_week_no_outliers <- Rt_result %>% 
#  filter(len == 300, method != "EpiEstim (monthly)") %>% 
#  select(Rt_case, dist, method, Rt_kl, si_type, si_pars) %>% 
#  group_by(Rt_case, dist, method) %>% 
#  mutate(big_out = Rt_kl > fivenum(Rt_kl, na.rm = TRUE)[4] +
#    1.5 * IQR(Rt_kl, na.rm = TRUE)) %>% 
#  filter(!big_out) %>% 
#  select(!big_out)

fig_kl_week_measles <- Rt_res_long_week_no_outliers %>%
  filter(si_type == "measles", si_pars == "measles", method != "EpiNow2") |> # SARS, measles?
  select(Rt_case, dist, method, Rt_kl) |> 
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl)) + 
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() + #labels = scientific_10
  scale_colour_manual(values = cbPalette[c(1,3,4,6:9)]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_week_measles)

fig_kl_week_sars <- Rt_res_long_week_no_outliers %>%
  filter(si_type == "SARS", si_pars == "SARS") |> # SARS, measles?
  select(Rt_case, dist, method, Rt_kl) |>
  group_by(Rt_case, dist, method) |>
  ggplot(aes(x = method, y = Rt_kl)) + # averaged over KL per coordinate
  stat_boxplot(aes(col = method)) +
  facet_grid(dist ~ Rt_case, scales = "free") +
  scale_y_log10() +
  scale_colour_manual(values = cbPalette[c(1,3,4,6:9)]) +
  labs(x = "Method", y = "KL divergence") +
  theme_bw() +
  theme(axis.text.x = element_blank(), legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_kl_week_sars)

ggsave(plot=fig_kl_week_measles, here::here("fig/fig_kl_week_measles.png"), width = 6.5, height = 5)
ggsave(plot=fig_kl_week_sars, here::here("fig/fig_kl_week_sars.png"), width = 6.5, height = 5)
```

```{r save-fitted-rt, eval = FALSE, include = FALSE}
## Rt estimates for Poisson incidence by all models
## Commands used to visualize fitted Rt are commented.

# EpiEstim(week) ----
Pois1_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_Epiweek <- problem_solver(method = 'EpiEstim(week)', instance = dat4_NB_SARS)$Rt_fitted

# EpiEstim(month) ----
Pois1_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_Epimonth <- problem_solver(method = 'EpiEstim(month)', instance = dat4_NB_SARS)$Rt_fitted

# EpiLPS ----
Pois1_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_EpiLPS <- problem_solver(method = 'EpiLPS', instance = dat4_NB_SARS)$Rt_fitted

# EpiFilter ----
Pois1_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_EpiFilter <- problem_solver(method = 'EpiFilter', instance = dat4_NB_SARS)$Rt_fitted

# RtEstim(k=0) ----
Pois1_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_RtEstim0 <- problem_solver(method = 'RtEstim(k=0)', instance = dat4_NB_SARS)$Rt_fitted

# RtEstim(k=1) ----
Pois1_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_RtEstim1 <- problem_solver(method = 'RtEstim(k=1)', instance = dat4_NB_SARS)$Rt_fitted

# RtEstim(k=2) ----
Pois1_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_RtEstim2 <- problem_solver(method = 'RtEstim(k=2)', instance = dat4_NB_SARS)$Rt_fitted

# RtEstim(k=3) ----
Pois1_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat1_pois_measles)$Rt_fitted
Pois2_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat2_pois_measles)$Rt_fitted
Pois3_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat3_pois_measles)$Rt_fitted
Pois4_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat4_pois_measles)$Rt_fitted
NB1_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat1_NB_measles)$Rt_fitted
NB2_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat2_NB_measles)$Rt_fitted
NB3_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat3_NB_measles)$Rt_fitted
NB4_measles_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat4_NB_measles)$Rt_fitted
Pois1_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat1_pois_SARS)$Rt_fitted
Pois2_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat2_pois_SARS)$Rt_fitted
Pois3_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat3_pois_SARS)$Rt_fitted
Pois4_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat4_pois_SARS)$Rt_fitted
NB1_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat1_NB_SARS)$Rt_fitted
NB2_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat2_NB_SARS)$Rt_fitted
NB3_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat3_NB_SARS)$Rt_fitted
NB4_SARS_RtEstim3 <- problem_solver(method = 'RtEstim(k=3)', instance = dat4_NB_SARS)$Rt_fitted

# save results ----
res_dat <- rbind(dat_example, dat_example, dat_example, dat_example,
                 dat_example, dat_example, dat_example, dat_example)
res_dat <- data.table(
  res_dat,
  EpiWeek = c(Pois1_measles_Epiweek, Pois2_measles_Epiweek, Pois3_measles_Epiweek, Pois4_measles_Epiweek, 
              NB1_measles_Epiweek, NB2_measles_Epiweek, NB3_measles_Epiweek, NB4_measles_Epiweek, 
              Pois1_SARS_Epiweek, Pois2_SARS_Epiweek, Pois3_SARS_Epiweek, Pois4_SARS_Epiweek, 
              NB1_SARS_Epiweek, NB2_SARS_Epiweek, NB3_SARS_Epiweek, NB4_SARS_Epiweek), 
  EpiMonth = c(Pois1_measles_Epimonth, Pois2_measles_Epimonth, Pois3_measles_Epimonth, Pois4_measles_Epimonth,
               NB1_measles_Epimonth, NB2_measles_Epimonth, NB3_measles_Epimonth, NB4_measles_Epimonth, 
               Pois1_SARS_Epimonth, Pois2_SARS_Epimonth, Pois3_SARS_Epimonth, Pois4_SARS_Epimonth, 
               NB1_SARS_Epimonth, NB2_SARS_Epimonth, NB3_SARS_Epimonth, NB4_SARS_Epimonth),
  EpiLPS = c(Pois1_measles_EpiLPS, Pois2_measles_EpiLPS, Pois3_measles_EpiLPS, Pois4_measles_EpiLPS, 
             NB1_measles_EpiLPS, NB2_measles_EpiLPS, NB3_measles_EpiLPS, NB4_measles_EpiLPS, 
             Pois1_SARS_EpiLPS, Pois2_SARS_EpiLPS, Pois3_SARS_EpiLPS, Pois4_SARS_EpiLPS, 
             NB1_SARS_EpiLPS, NB2_SARS_EpiLPS, NB3_SARS_EpiLPS, NB4_SARS_EpiLPS),
  EpiFilter = c(Pois1_measles_EpiFilter, Pois2_measles_EpiFilter, Pois3_measles_EpiFilter, Pois4_measles_EpiFilter,
                NB1_measles_EpiFilter, NB2_measles_EpiFilter, NB3_measles_EpiFilter, NB4_measles_EpiFilter,
                Pois1_SARS_EpiFilter, Pois2_SARS_EpiFilter, Pois3_SARS_EpiFilter, Pois4_SARS_EpiFilter, 
                NB1_SARS_EpiFilter, NB2_SARS_EpiFilter, NB3_SARS_EpiFilter, NB4_SARS_EpiFilter),
  RtEstim0 = c(Pois1_measles_RtEstim0, Pois2_measles_RtEstim0, Pois3_measles_RtEstim0, Pois4_measles_RtEstim0,
               NB1_measles_RtEstim0, NB2_measles_RtEstim0, NB3_measles_RtEstim0, NB4_measles_RtEstim0, 
               Pois1_SARS_RtEstim0, Pois2_SARS_RtEstim0, Pois3_SARS_RtEstim0, Pois4_SARS_RtEstim0, 
               NB1_SARS_RtEstim0, NB2_SARS_RtEstim0, NB3_SARS_RtEstim0, NB4_SARS_RtEstim0),
  RtEstim1 = c(Pois1_measles_RtEstim1, Pois2_measles_RtEstim1, Pois3_measles_RtEstim1, Pois4_measles_RtEstim1,
               NB1_measles_RtEstim1, NB2_measles_RtEstim1, NB3_measles_RtEstim1, NB4_measles_RtEstim1, 
               Pois1_SARS_RtEstim1, Pois2_SARS_RtEstim1, Pois3_SARS_RtEstim1, Pois4_SARS_RtEstim1, 
               NB1_SARS_RtEstim1, NB2_SARS_RtEstim1, NB3_SARS_RtEstim1, NB4_SARS_RtEstim1),
  RtEstim2 = c(Pois1_measles_RtEstim2, Pois2_measles_RtEstim2, Pois3_measles_RtEstim2, Pois4_measles_RtEstim2,
               NB1_measles_RtEstim2, NB2_measles_RtEstim2, NB3_measles_RtEstim2, NB4_measles_RtEstim2, 
               Pois1_SARS_RtEstim2, Pois2_SARS_RtEstim2, Pois3_SARS_RtEstim2, Pois4_SARS_RtEstim2, 
               NB1_SARS_RtEstim2, NB2_SARS_RtEstim2, NB3_SARS_RtEstim2, NB4_SARS_RtEstim2),
  RtEstim3 = c(Pois1_measles_RtEstim3, Pois2_measles_RtEstim3, Pois3_measles_RtEstim3, Pois4_measles_RtEstim3,
               NB1_measles_RtEstim3, NB2_measles_RtEstim3, NB3_measles_RtEstim3, NB4_measles_RtEstim3, 
               Pois1_SARS_RtEstim3, Pois2_SARS_RtEstim3, Pois3_SARS_RtEstim3, Pois4_SARS_RtEstim3, 
               NB1_SARS_RtEstim3, NB2_SARS_RtEstim3, NB3_SARS_RtEstim3, NB4_SARS_RtEstim3)
)

res_dat <- res_dat %>%
  mutate(Rt_case = fct_recode(Rt_case,
    "Scenario 1: piecewise constant" = "Scenario 1",
    "Scenario 2: piecewise exponential" = "Scenario 2",
    "Scenario 3: piecewise linear" = "Scenario 3",
    "Scenario 4: periodic" = "Scenario 4"
  )) %>%
  mutate(dist = fct_relevel(dist, "Poisson", "Negative Binomial"))

saveRDS(res_dat, here::here("dat/data_example_estimates.RDS"))
```

```{r Figs-display-fitted-rt, eval = FALSE, include = FALSE}
res_dat_long <- res_dat %>%
  pivot_longer(EpiWeek:RtEstim3, names_to = "method", values_to = "Rt_value") %>%
  mutate(method = fct_recode(method,
    "EpiEstim (weekly)" = "EpiWeek",
    "EpiEstim (monthly)" = "EpiMonth",
    "RtEstim (k=0)" = "RtEstim0",
    "RtEstim (k=1)" = "RtEstim1",
    "RtEstim (k=2)" = "RtEstim2",
    "RtEstim (k=3)" = "RtEstim3"
  )) %>%
  mutate(method = fct_relevel(
    method, 
    "EpiEstim (weekly)", "EpiEstim (monthly)", "EpiLPS", "EpiFilter", "EpiNow2",
    "RtEstim (k=0)", "RtEstim (k=1)", "RtEstim (k=2)", "RtEstim (k=3)"
  ))

fig_res_pois_measles <- res_dat_long %>%
  filter(si_type == "measles", dist == "Poisson", time > 14) %>% 
  #filter(method != "EpiLPS") %>% # EpiLPS is large for the first 14 days
  group_by(Rt_case, method) %>%
  ggplot(aes(y = Rt_value, x = time)) + 
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(col = method)) +
  facet_wrap( ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[-5]) +
  labs(y = "Rt estimates for measles epidemics with Poisson incidence") + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_res_pois_measles)

fig_res_pois_sars <- res_dat_long %>%
  filter(si_type == "SARS", dist == "Poisson") %>% 
  group_by(Rt_case, method) %>%
  ggplot(aes(y = Rt_value, x = time)) + 
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(col = method)) +
  facet_wrap( ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[-5]) +
  labs(y = "Rt estimates for SARS epidemics with Poisson incidence") + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_res_pois_sars)

fig_res_NB_measles <- res_dat_long %>%
  filter(si_type == "measles", dist == "Negative Binomial", time > 14) %>% 
  #filter(method != "EpiLPS") %>% # EpiLPS is large for the first 14 days
  group_by(Rt_case, method) %>%
  ggplot(aes(y = Rt_value, x = time)) + 
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(col = method)) +
  facet_wrap( ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[-5]) +
  labs(y = "Rt estimates for measles epidemics with NB incidence") + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_res_NB_measles)

fig_res_NB_sars <- res_dat_long %>%
  filter(si_type == "SARS", dist == "Negative Binomial") %>% 
  group_by(Rt_case, method) %>%
  ggplot(aes(y = Rt_value, x = time)) + 
  geom_line(aes(y = trueRt)) + 
  geom_line(aes(col = method)) +
  facet_wrap( ~ Rt_case, scales = "free") +
  scale_colour_manual(values = cbPalette[-5]) +
  labs(y = "Rt estimates for SARS epidemics with NB incidence") + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(title = NULL, byrow=TRUE))
print(fig_res_NB_sars)

ggsave(plot=fig_res_pois_measles, here::here("fig/fig_res_pois_measles.png"), width = 6.5, height = 5)
ggsave(plot=fig_res_NB_measles, here::here("fig/fig_res_NB_measles.png"), width = 6.5, height = 5)
ggsave(plot=fig_res_pois_sars, here::here("fig/fig_res_pois_sars.png"), width = 6.5, height = 5)
ggsave(plot=fig_res_NB_sars, here::here("fig/fig_res_NB_sars.png"), width = 6.5, height = 5)
```

```{r Fig6-display-covid-BC-incidence, eval=FALSE, include=FALSE}
# Get covid-19 incidence in BC
library(CanCovidData)
dat <- get_british_columbia_case_data() %>%
  rename(HA = `Health Authority`, Date = `Reported Date`, Age = `Age group`) %>%
  filter(Date >= ymd("2020-03-01"))
cases <- dat %>% count(Date, name = "Cases")
Covid_case <- cases %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Cases), col = "black") +
  labs(x = "Month", y = "Covid-19 daily confirmed case counts in BC") +
  scale_x_date(date_breaks = "6 months", date_labels = "%Y-%m") +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.title = element_text(hjust = 0.5),
    panel.spacing = unit(0.8, "lines"),
    text = element_text(size = 12)
  )
print(Covid_case)

ggsave(here::here("fig/covid_dat.png"), Covid_case, width = 6.5, height = 5)
```

```{r Fig7-display-covid-BC-Rt-est, eval=FALSE, include=FALSE}
## estimate Rt using RtEstim
# k=1
mod_rt_covid1 <- estimate_rt(
  x = cases$Date, cases$Cases, korder = 1, nsol = 50,
  maxiter = 1e7L
)
cv_mod_covid1 <- cv_estimate_rt(
  x = cases$Date, cases$Cases, korder = 1, nfold = 10,
  maxiter = 1e7L, nsol = 50
)
mod_rtestim_covid1 <- cv_mod_covid1$full_fit$Rt[, which.min(cv_mod_covid1$cv_scores)]
rt_ci_covid1 <- confband(cv_mod_covid1, "lambda.min") # get 95% confidence band

# k=2
mod_rt_covid2 <- estimate_rt(
  x = cases$Date, cases$Cases, korder = 2, nsol = 50,
  maxiter = 1e7L
)
cv_mod_covid2 <- cv_estimate_rt(
  x = cases$Date, cases$Cases, korder = 2, nfold = 10,
  maxiter = 1e7L, nsol = 50
)
mod_rtestim_covid2 <- cv_mod_covid2$full_fit$Rt[, which.min(cv_mod_covid2$cv_scores)]
rt_ci_covid2 <- confband(cv_mod_covid2, "lambda.min") # get 95% confidence band

# k=3
mod_rt_covid3 <- estimate_rt(
  x = cases$Date, cases$Cases, korder = 3, nsol = 50,
  maxiter = 1e7L
)
cv_mod_covid3 <- cv_estimate_rt(
  x = cases$Date, cases$Cases, korder = 3, nfold = 10,
  maxiter = 1e7L, nsol = 50
)
mod_rtestim_covid3 <- cv_mod_covid3$full_fit$Rt[, which.min(cv_mod_covid3$cv_scores)]
rt_ci_covid3 <- confband(cv_mod_covid3, "lambda.min") # get 95% confidence band

# Rt values with a candidate set
n <- length(mod_rt_covid3$observed_counts)
k <- length(mod_rt_covid3$lambda)
df3 <- data.frame(
    Rt = c(mod_rt_covid3$Rt),
    lambda = rep(mod_rt_covid3$lambda, each = n),
    Time = rep(mod_rt_covid3$x, k),
    degree = 3
)
df2 <- data.frame(
    Rt = c(mod_rt_covid2$Rt),
    lambda = rep(mod_rt_covid2$lambda, each = n),
    Time = rep(mod_rt_covid2$x, k),
    degree = 2
)
df1 <- data.frame(
    Rt = c(mod_rt_covid1$Rt),
    lambda = rep(mod_rt_covid1$lambda, each = n),
    Time = rep(mod_rt_covid1$x, k),
    degree = 1
)
df_covid_Rt<- rbind(df1, df2, df3)
df_covid_Rt$degree <- as.factor(df_covid_Rt$degree)

fig_covid_Rt <- df_covid_Rt %>%
  mutate(degree = fct_recode(degree,
    "Piecewise linear Rt" = "1",
    "Piecewise quadratic Rt" = "2",
    "Piecewise cubic Rt" = "3"
  )) %>%
  group_by(degree, lambda) %>%
  ggplot(aes(Time, Rt, colour = lambda, group = lambda)) +
  geom_line() +
  facet_wrap(~ degree, scales = "free_y", ncol = 1) + 
  labs(y ="Rt estimates for Covid-19 pandemic in BC", x = "Year", color = "\u03BB") +
  scale_colour_viridis_c(trans = "log10", breaks = c(1, 1e2L, 1e4L, 1e6L), labels = c(1, expression(10^2), expression(10^4), expression(10^6))) +
  guides(color = guide_colorbar(barwidth = 10, barheight = 1)) +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y", expand = expansion(c(0, 0.05))) +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  geom_hline(yintercept = 1) +
  theme_bw() +
  theme(legend.position = "bottom")
  
# CV-chosen Rt with CB
rt_ci_covid3 <- as.data.table(rt_ci_covid3) %>% 
  mutate(degree = 3, lambda = cv_mod_covid3$lambda.min) %>% 
  mutate(Date = cases$Date) 
rt_ci_covid2 <- as.data.table(rt_ci_covid2) %>% 
  mutate(degree = 2, lambda = cv_mod_covid2$lambda.min) %>% 
  mutate(Date = cases$Date) 
rt_ci_covid1 <- as.data.table(rt_ci_covid1) %>% 
  mutate(degree = 1, lambda = cv_mod_covid1$lambda.min) %>% 
  mutate(Date = cases$Date) 
df_covid_ci <- rbind(rt_ci_covid1, rt_ci_covid2, rt_ci_covid3)
df_covid_ci$degree = as.factor(df_covid_ci$degree)

fig_covid_ci <- df_covid_ci %>% 
  mutate(degree = fct_recode(degree,
    "Piecewise linear Rt" = "1",
    "Piecewise quadratic Rt" = "2",
    "Piecewise cubic Rt" = "3"
  )) %>%
  group_by(degree, lambda) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Rt)) +
  facet_wrap(~ degree, scales = "free_y", ncol = 1) + 
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`),
    fill = "gray", alpha = 0.5
  ) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y", expand = expansion(c(0, 0.05))) +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  labs(x = "Year", y = "") +
  theme_bw()

Covid_BC_Rt <- ggarrange(fig_covid_Rt, fig_covid_ci,
                         ncol = 2, nrow = 1, 
                         common.legend = TRUE, legend = "bottom"
)
print(Covid_BC_Rt)

ggsave(here::here("fig/covid_full_res.png"), Covid_BC_Rt, width = 6.5, height = 5)
```

```{r Fig8-display-influenza1918-data, eval=FALSE, include=FALSE}
# get the flu data from `EpiEstim` package
data("Flu1918")
n <- length(Flu1918$incidence)
flu_dat <- data.frame(Flu_incidence = Flu1918$incidence, Time = 1:n)
Flu_case <- flu_dat %>%
  ggplot(aes(x = Time)) +
  geom_line(aes(y = Flu_incidence)) +
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  labs(x = "Days since start of epidemic", y = "1918 Influenza daily incidence in Baltimore") +
  theme_bw()
  
print(Flu_case)

ggsave(here::here("fig/flu_dat.png"), Flu_case, width = 6.5, height = 5)
```


```{r Fig9-display-influenza1918-Rt-est, eval=FALSE, include=FALSE}
mod_rt_flu3 <- estimate_rt(Flu1918$incidence, korder = 3, nsol = 50)
cv_mod_flu3 <- cv_estimate_rt(Flu1918$incidence, korder = 3, nfold = 10, nsol = 50)
rt_ci_flu3 <- confband(cv_mod_flu3, "lambda.1se") 

mod_rt_flu2 <- estimate_rt(Flu1918$incidence, korder = 2, nsol = 50)
cv_mod_flu2 <- cv_estimate_rt(Flu1918$incidence, korder = 2, nfold = 10, nsol = 50)
rt_ci_flu2 <- confband(cv_mod_flu2, "lambda.1se") 

mod_rt_flu1 <- estimate_rt(Flu1918$incidence, korder = 1, nsol = 50)
cv_mod_flu1 <- cv_estimate_rt(Flu1918$incidence, korder = 1, nfold = 10, nsol = 50)
rt_ci_flu1 <- confband(cv_mod_flu1, "lambda.1se") 

# Rt values with a candidate set
n <- length(mod_rt_flu3$observed_counts)
k <- length(mod_rt_flu3$lambda)
df_flu3 <- data.frame(
    Rt = c(mod_rt_flu3$Rt),
    lambda = rep(mod_rt_flu3$lambda, each = n),
    Time = rep(mod_rt_flu3$x, k),
    degree = 3
)
df_flu2 <- data.frame(
    Rt = c(mod_rt_flu2$Rt),
    lambda = rep(mod_rt_flu2$lambda, each = n),
    Time = rep(mod_rt_flu2$x, k),
    degree = 2
)
df_flu1 <- data.frame(
    Rt = c(mod_rt_flu1$Rt),
    lambda = rep(mod_rt_flu1$lambda, each = n),
    Time = rep(mod_rt_flu1$x, k),
    degree = 1
)
df_flu_Rt<- rbind(df_flu1, df_flu2, df_flu3)
df_flu_Rt$degree <- as.factor(df_flu_Rt$degree)

fig_flu_Rt <- df_flu_Rt %>%
  mutate(degree = fct_recode(degree,
    "Piecewise linear Rt" = "1",
    "Piecewise quadratic Rt" = "2",
    "Piecewise cubic Rt" = "3"
  )) %>%
  group_by(degree, lambda) %>%
  ggplot(aes(Time, Rt, colour = lambda, group = lambda)) +
  geom_line() +
  facet_wrap(~ degree, scales = "free_y", ncol = 1) + 
  labs(y ="Rt estimates for 1918 Influenza in Baltimore", x = "Days since start of epidemic", color = "\u03BB") +
  scale_colour_viridis_c(trans = "log10", breaks = c(0.1, 1, 10, 100, 1000), labels = c(0.1, 1, 10, expression(10^2), expression(10^3))) +
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  guides(color = guide_colorbar(barwidth = 10, barheight = 1)) +
  geom_hline(yintercept = 1) +
  theme_bw() +
  theme(legend.position = "bottom")

rt_ci_flu3 <- as.data.table(rt_ci_flu3) %>% 
  mutate(degree = 3, lambda = cv_mod_flu3$lambda.min) %>% 
  mutate(Day = flu_dat$Time) 
rt_ci_flu2 <- as.data.table(rt_ci_flu2) %>% 
  mutate(degree = 2, lambda = cv_mod_flu2$lambda.min) %>% 
  mutate(Day = flu_dat$Time) 
rt_ci_flu1 <- as.data.table(rt_ci_flu1) %>% 
  mutate(degree = 1, lambda = cv_mod_flu1$lambda.min) %>% 
  mutate(Day = flu_dat$Time) 
df_flu_ci <- rbind(rt_ci_flu1, rt_ci_flu2, rt_ci_flu3)
df_flu_ci$degree = as.factor(df_flu_ci$degree)

fig_flu_ci <- df_flu_ci %>% 
  mutate(degree = fct_recode(degree,
    "Piecewise linear Rt" = "1",
    "Piecewise quadratic Rt" = "2",
    "Piecewise cubic Rt" = "3"
  )) %>%
  group_by(degree, lambda) %>%
  ggplot(aes(x = Day)) +
  geom_line(aes(y = Rt)) +
  facet_wrap(~ degree, scales = "free_y", ncol = 1) + 
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`),
    fill = "gray", alpha = 0.5
  ) +
  scale_x_continuous(expand = expansion(c(0, 0.05))) + 
  scale_y_continuous(expand = expansion(c(0, 0.05))) + 
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(x = "Days since start of epidemic", y = "") +
  theme_bw()

Flu_Rt <- ggarrange(fig_flu_Rt, fig_flu_ci,
  ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom"
)
print(Flu_Rt)

ggsave(here::here("fig/flu_full_res.png"), Flu_Rt, width = 6.5, height = 5)
```
